
# 1 基于CA签名的双向数字证书认证方式

在一个**安全的内网环境**中，Kubernetes的各个组件**与Master之间**可以通过**kube\-apiserver**的**非安全端口http:\/\/\<kube-apiserver\-ip>:8080**进行访问。

但如果API Server需要**对外提供服务**，或者集群中的**某些容器**也需要**访问API Server**以获取集群中的某些信息，则更安全的做法是**启用HTTPS安全机制**。

Kubernetes提供了**基于CA签名的双向数字证书认证方式**和**简单的基于HTTP Base或Token的认证方式**，其中CA证书方式的安全性最高。

基于CA签名的**双向数字证书的生成过程**如下.

（1）为**kube\-apiserver**生成一个**数字证书**，并用**CA证书签名**。

（2）为kube\-apiserver进程**配置证书相关的启动参数**，包括**CA证书**（用于**验证客户端证书的签名真伪**）、自己的经过**CA签名后的证书**及**私钥**。

（3）为每个访问Kubernetes API Server的**客户端**（如kube\-controller\-manager、kube\-scheduler、kubelet、kube\-proxy及调用API Server的客户端程序kubectl等）进程都**生成自己的数字证书**，也都用**CA证书签名**，在相关**程序的启动参数里增加CA证书**、**自己的证书**等相关参数。

## 1.1 设置kube-apiserver的CA证书相关的文件和启动参数

使用OpenSSL工具在Master服务器上**创建CA证书**和**私钥相关的文件**：

```
# openssl genrsa -out ca.key 2048

# openssl req -x509 -new -nodes -key ca.key -subj "/CN=k8s-master" -days 5000 -out ca.crt

# openssl genrsa -out server.key 2048
```

注: 生成ca.crt时，\-subj参数中“/**CN**”的值为Master主机名。

准备master\_ssl.cnf文件，该文件用于**x509 v3版本的证书**。在该文件中主要需要设置**Master服务器的hostname**（k8s\-master）、**IP地址**（192.168.18.3），以及Kubernetes Master **Service的虚拟服务名称**（kubernetes.default等）和**该虚拟服务的ClusterIP**地址（169.169.0.1）。

```conf
# master_ssl.cnf
[req]
req_extensions = v3_req
distinguished_name = req_distinguished_name
[req_distinguished_name]
[ v3_req ]
basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
subjectAltName = @alt_names
[alt_names]
DNS.1 = kubernetes
DNS.2 = kubernetes.default
DNS.3 = kubernetes.default.svc
DNS.4 = kubernetes.default.svc.cluster.local
DNS.5 = k8s-master
IP.1 = 169.169.0.1
IP.2 = 192.168.18.3
```

**基于master\_ssl.cnf**创建server.**csr**和server.**crt**文件。

在生成server.csr时，\-subj参数中“/CN”的值需为Master的主机名：

```
# openssl req -new -key server.key -subj "/CN=k8s-master" -config master_ssl.cnf -out server.csr

# openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -days 5000 -extensions v3_req -extfile master_ssl.cnf -out server.crt
```

在全部执行完后会生成6个文件：ca.crt、ca.key、ca.srl、server.crt、server.csr、server.key。

将这些文件复制到一个目录下（例如/var/run/kubernetes/），然后设置**kube\-apiserver**的**三个启动参数**“\-\-client\-ca\-file” “\-\-tls\-cert\-file”和“\-\-tls\-private\-key\-file”，分别代表**CA根证书文件**、**服务端证书文件**和**服务端私钥文件**：

```
--client-ca-file=/var/run/kubernetes/ca.crt  
--tls-cert-file=/var/run/kubernetes/server.crt
--tls-private-key-file=/var/run/kubernetes/server.key
```

同时，可以**关闭非安全端口**（设置\-\-insecure\-port=0），设置**安全端口为6443**（默认值）：

```
--insecure-port=0 
--secure-port=6443
```

最后重启kube-apiserver服务

```
# /etc/kubernetes/apiserver
KUBE_API_ARGS="--etcd-servers=http://127.0.0.1:2379 --client-ca-file=/var/run/kubernetes/ca.crt --tls-private-key-file=/var/run/kubernetes/server.key --tls-cert-file=/var/run/kubernetes/server.crt --insecure-port=0 --secure-port=6443 --service-cluster-ip-range=169.169.0.0/16 --service-node-port-range=1-65535 --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota --logtostderr=false --log-dir=/var/log/kubernetes --v=0"
```

## 1.2 设置kube-controller-manager的客户端证书、私钥和启动参数

```

```

其中，在生成cs\_client.crt时，\-CA参数和\-CAkey参数使用的是API Server的ca.crt和ca.key文件。然后将这些文件复制到一个目录下（例如/var/run/kubernetes/）。

