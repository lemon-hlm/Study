
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [0 概述](#0-概述)
- [1 安装kubeadm和相关工具](#1-安装kubeadm和相关工具)
- [2 kubeadm config](#2-kubeadm-config)
- [3 下载Kubernetes的相关镜像](#3-下载kubernetes的相关镜像)
- [4 安装Master](#4-安装master)
- [5 安装Node, 加入集群](#5-安装node-加入集群)
- [6 安装网络插件](#6-安装网络插件)
- [7 安装Kubernetes集群是否安装完成](#7-安装kubernetes集群是否安装完成)

<!-- /code_chunk_output -->

# 0 概述

最简单方法是使用`yum install kubernetes`命令安装Kubernetes集群，但仍需**修改各组件的启动参数**，才能完成对Kubernetes集群的配置，整个过程比较复杂，也容易出错。

Kubernetes从1.4版本开始引入了**命令行工具kubeadm**，致力于简化集群的安装过程，并解决Kubernetes集群的高可用问题。

# 1 安装kubeadm和相关工具

在所有节点上

先配置yum源, 官方yum源地址为`https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64`. 

可以使用国内的一个yum源, 比如腾讯的, 地址为`http://mirrors.tencent.com/kubernetes/yum/repos/kubernetes-el7-x86_64/`, 配置如下

阿里云的baseurl是http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/

```
[root@localhost ~]# vim /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes Repo
baseurl=http://mirrors.tencent.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=0

[root@localhost ~]# yum makecache
```

安装kubeadm和相关工具:

```
[root@localhost ~]# yum install -y kubelet kubeadm kubectl --disableexcludes=kebernetes
```

启动docker服务和kubelet服务, 并设为开机自动启动:

```
# systemctl enable docker && systemctl start docker
# systemctl enable kubelet && systemctl start kubelet
```

注: 这时候的kubelet服务不是active状态, 是正常的

# 2 kubeadm config

kubeadm提供了配置文件功能用于复杂定制。同时，kubeadm将配置文件以ConfigMap的形式保存到集群之中，便于后续的查询和升级工作。kubeadm config子命令提供了对这一组功能的支持：

- kubeadm config upload from\-file：由配置文件上传到集群中生成ConfigMap。
- kubeadm config upload from\-flags：由配置参数生成ConfigMap。
- kubeadm config view：查看当前集群中的配置值。
- kubeadm config print init\-defaults：输出kubeadm init默认参数文件的内容。
- kubeadm config print join\-defaults：输出kubeadm join默认参数文件的内容。
- kubeadm config migrate：在新旧版本之间进行配置转换。
- kubeadm config images list：列出所需的镜像列表。
- kubeadm config images pull：拉取镜像到本地。

执行`kubeadm config print init\-defaults`, 可获取默认的初始化参数文件:

```
# kubeadm config print init-defaults > init.default.yaml
```

可修改为合适的配置. 例如, 镜像仓库的地址, 以及Pod的地址范围, 可使用如下配置:

```
apiVersion: kubeadm.k8s.io/v1beta1
kind: ClusterConfiguration
imageRepository: docker.io/dustise
kubernetesVersion: v1.14.0
networking:
  podSubnet: "192.168.0.0/16"
```

```
apiVersion: kubeadm.k8s.io/v1beta2
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: 172.16.100.139
  bindPort: 6443
nodeRegistration:
  taints:
  - effect: PreferNoSchedule
    key: node-role.kubernetes.io/master
---
apiVersion: kubeadm.k8s.io/v1beta2
kind: ClusterConfiguration
kubernetesVersion: v1.15.0
networking:
  podSubnet: 192.168.0.0/16
```

将上面内容保存为init\-config.yaml备用

# 3 下载Kubernetes的相关镜像

为了从国内的镜像托管站点获得镜像加速支持，建议修改Docker的配置文件，增加Registry Mirror参数，将镜像配置写入配置参数中，例如echo '{"registry-mirrors":\["https://registry.docker-cn.com"]}' > /etc/docker/daemon.json，然后重启Docker服务。

使用config images pull子命令下载所需镜像，例如：

```
# kubeadm config images pull  --config=init-config.yaml
```

![2019-08-14-20-34-05.png](./images/2019-08-14-20-34-05.png)

# 4 安装Master

执行kubeadm init命令即可一键安装Kubernetes的Master。

```
[root@master01 ~]# kubeadm init --config=kubeadm.yaml --ignore-preflight-errors=all
......
Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 172.16.100.139:6443 --token cfnvuv.lae6eb8jkqkg09ko \
    --discovery-token-ca-cert-hash sha256:f64e6a9257be7fd89539a0181febd40670273bfaaf9853942f16a15861036d82
```

按照提示, 复制配置文件到用户的home目录下:

```
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

这样就在Master上安装了Kubernetes，但在集群内还是没有可用的工作Node，并缺乏对容器网络的配置。

这里需要注意kubeadm init命令执行完成后的最后几行提示信息，其中包含加入节点的指令（kubeadm join）和所需的Token。

验证ConfigMap

```
[root@master01 ~]# kubectl get -n kube-system configmap
NAME                                 DATA   AGE
coredns                              1      7m42s
extension-apiserver-authentication   6      7m46s
kube-proxy                           2      7m42s
kubeadm-config                       2      7m44s
kubelet-config-1.15                  1      7m44s
```

可以看到其中生成了名为kubeadm-config的ConfigMap对象。

查看一下集群状态，确认个组件都处于healthy状态：

```
[root@master01 ~]# kubectl get cs
NAME                 STATUS    MESSAGE             ERROR
controller-manager   Healthy   ok
scheduler            Healthy   ok
etcd-0               Healthy   {"health":"true"}
```

# 5 安装Node, 加入集群

对于新节点的添加，系统准备和Kubernetes yum源的配置过程是一致的，在Node主机上执行下面的安装过程。

(1) 安装kubeadm和相关工具

```
[root@localhost ~]# yum install -y kubelet kubeadm kubectl --disableexcludes=kebernetes
```

启动docker服务和kubelet服务, 并设为开机自动启动:

```
# systemctl enable docker && systemctl start docker
# systemctl enable kubelet && systemctl start kubelet
```

注: 这时候的kubelet服务不是active状态, 是正常的

(2) 为kubeadm命令生成配置文件

```
[root@node01 ~]# kubeadm config print join-defaults > join.yaml
```

其中，apiServerEndpoint的值来自Master服务器的地址，token和tlsBootstrapToken的值就来自于使用kubeadm init安装Master的最后一行提示信息。

修改结果

```
[root@node01 ~]# cat join.yaml
apiVersion: kubeadm.k8s.io/v1beta2
caCertPath: /etc/kubernetes/pki/ca.crt
discovery:
  bootstrapToken:
    apiServerEndpoint: 172.16.100.139:6443
    token: cfnvuv.lae6eb8jkqkg09ko
    unsafeSkipCAVerification: true
  timeout: 5m0s
  tlsBootstrapToken: cfnvuv.lae6eb8jkqkg09ko
kind: JoinConfiguration
nodeRegistration:
  criSocket: /var/run/dockershim.sock
  name: node01
  taints: null
```

(3) 执行kubeadm join命令, 将本Node加入集群:

```
[root@node01 ~]# kubeadm join --config=join.yaml
[preflight] Running pre-flight checks
[preflight] Reading configuration from the cluster...
[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'
[kubelet-start] Downloading configuration for the kubelet from the "kubelet-config-1.15" ConfigMap in the kube-system namespace
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
[kubelet-start] Activating the kubelet service
[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...

This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the control-plane to see this node join the cluster.
```

kubeadm在Master上也安装了kubelet，在默认情况下并不参与工作负载。如果希望安装一个单机All\-In\-One的Kubernetes环境，则可以执行下面的命令（删除Node的Label“node\-role.kubernetes.io/master”），让Master成为一个Node：

```
# kubectl taint nodes --all node-role.kubernetes.io/master-
```

# 6 安装网络插件

执行kubectl get nodes命令，会发现Kubernetes提示Master为NotReady状态，这是因为还没有安装CNI网络插件

```
[root@master01 ~]# kubectl get nodes
NAME       STATUS     ROLES    AGE   VERSION
master01   NotReady   master   41m   v1.15.2
node01     NotReady   <none>   84s   v1.15.2
```

下面根据kubeadm的提示安装CNI网络插件。对于CNI网络插件，可以有许多选择，请参考 https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/#pod-network 的说明。

例如，选择weave插件，执行下面的命令即可一键完成安装：

```
[root@master01 ~]# kubectl apply -f "https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\n')"
serviceaccount/weave-net created
clusterrole.rbac.authorization.k8s.io/weave-net created
clusterrolebinding.rbac.authorization.k8s.io/weave-net created
role.rbac.authorization.k8s.io/weave-net created
rolebinding.rbac.authorization.k8s.io/weave-net created
daemonset.extensions/weave-net created
```

# 7 安装Kubernetes集群是否安装完成

执行下面的命令，验证Kubernetes集群的相关Pod是否都正常创建并运行：

```
[root@master01 ~]# kubectl get pods --all-namespaces
NAMESPACE     NAME                               READY   STATUS    RESTARTS   AGE
kube-system   coredns-5c98db65d4-k5gdt           1/1     Running   0          63m
kube-system   coredns-5c98db65d4-t6fnr           1/1     Running   0          63m
kube-system   etcd-master01                      1/1     Running   0          62m
kube-system   kube-apiserver-master01            1/1     Running   0          62m
kube-system   kube-controller-manager-master01   1/1     Running   0          62m
kube-system   kube-proxy-6xg9p                   1/1     Running   0          63m
kube-system   kube-proxy-mf9h2                   1/1     Running   0          23m
kube-system   kube-scheduler-master01            1/1     Running   0          63m
kube-system   weave-net-2ql4b                    2/2     Running   0          74s
kube-system   weave-net-f4gb8                    2/2     Running   0          74s
```

如果发现有状态错误的Pod，则可以执行kubectl \-\-namespace=kube\-system describe pod\<pod\_name>来查看错误原因，常见的错误原因是镜像没有下载完成。

至此，通过kubeadm工具就实现了Kubernetes集群的快速搭建。如果安装失败，则可以执行kubeadm reset命令将主机恢复原状，重新执行kubeadm init命令，再次进行安装。