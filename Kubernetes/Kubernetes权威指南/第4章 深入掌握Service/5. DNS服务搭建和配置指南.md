
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [0 概述](#0-概述)
  - [0.1 服务名到ClusterIP的解析](#01-服务名到clusterip的解析)
  - [0.2 3个阶段](#02-3个阶段)
    - [0.2.1 SkyDNS: 1.2版本](#021-skydns-12版本)
    - [0.2.2 KubeDNS: 1.4版本](#022-kubedns-14版本)
    - [0.2.3](#023)

<!-- /code_chunk_output -->

# 0 概述

## 0.1 服务名到ClusterIP的解析

作为**服务发现机制的基本功能**，在集群内需要能够**通过服务名对服务进行访问**，这就需要一个**集群范围内**的**DNS服务**来完成从**服务名到ClusterIP！！！** 的解析。

## 0.2 3个阶段

**DNS服务**在Kubernetes的发展过程中经历了**3个阶段**，接下来会进行讲解。

### 0.2.1 SkyDNS: 1.2版本

在Kubernetes **1.2版本**时，DNS服务是由**SkyDNS**提供的，它由**4个容器**组成：**kube2sky**、**skydns**、**etcd**和**healthz**。

- **kube2sky**容器**监控**Kubernetes中**Service资源的变化**，根据**Service的名称**和**IP地址**信息**生成DNS记录**，并将其保存到**etcd**中；
- **skydns容器**从**etcd**中**读取DNS记录**，并为客户端容器应用**提供DNS查询服务**；
- **healthz容器**提供对**skydns服务**的**健康检查功能**。

图4.3展现了SkyDNS的总体架构:

![2019-08-30-14-23-48.png](./images/2019-08-30-14-23-48.png)

### 0.2.2 KubeDNS: 1.4版本

从Kubernetes **1.4版本**开始，SkyDNS组件便被**KubeDNS**替换，主要考虑是**SkyDNS组件之间通信较多**，整体**性能不高**。

KubeDNS由**3个容器**组成：**kubedns**、**dnsmasq**和**sidecar**，去掉了SkyDNS中的**etcd存储**，将**DNS记录**直接**保存在内存**中，以**提高查询性能**。

- **kubedns容器**监控Kubernetes中**Service资源的变化**，根据**Service的名称**和**IP地址**生成**DNS记录**，并将**DNS记录**保存在**内存**中；
- **dnsmasq容器**从kubedns中**获取DNS记录**，提供**DNS缓存**，为**客户端容器应用**提供**DNS查询服务**；
- **sidecar**提供对**kubedns**和**dnsmasq**服务的**健康检查**功能。

图4.4展现了KubeDNS的总体架构。

![2019-08-30-14-25-36.png](./images/2019-08-30-14-25-36.png)

### 0.2.3 
从Kubernetes **1.11版本**开始，Kubernetes集群的DNS服务由**CoreDNS**提供。CoreDNS是**CNCF基金会**的一个项目，是用**Go语言**实现的**高性能**、**插件式**、**易扩展**的DNS服务端。

CoreDNS解决了KubeDNS的一些问题，例如**dnsmasq的安全漏洞**、**externalName不能使用stubDomains设置**，等等。

CoreDNS支持**自定义DNS记录**及**配置upstream DNS Server**，可以统一管理Kubernetes**基于服务的内部DNS**和**数据中心的物理DNS**。

CoreDNS**没有使用多个容器的架构**，只用**一个容器**便实现了KubeDNS内3个容器的全部功能。
