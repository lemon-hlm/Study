[TOC]

本章以Montevina平台为例, 说明在x86处理器系统中, PCIe体系结构的实现机制.

Montevina平台是Intel提供的一个笔记本平台. 在这个平台上, 含有一个**mobile芯片组**, **Mobile处理器**和**无线网卡**. 

- 其中**Mobile芯片组**包括代号为"Contiga"的**GMCH(Graphics and Memory Controller Hub**)和ICH9M系列的**ICH**; 
- **Mobile处理器**使用代号为"Penryn"的第二代**Intel Core2 Duo**; 
- **无线网卡**的代号为"Shirley Peak"(支持Wifi)或者"Echo Peak"(同时支持Wifi和WiMax). 
 
Montevina平台的拓扑结构如图.

![config](./images/1.png)

Montevina平台使用一个**虚拟的FSB\-to\-PCI桥**将**FSB总线**和**外部设备**分离, 这个**虚拟PCI桥**上方连接**FSB总线**, 下方连接**PCI总线0**. 但是从**物理信号**来看, MCH中的**PCI总线0**是**FSB总线的延伸**, 因为该**PCI总线0**仍然**使用FSB总线的信号**, 只是**连接到这条总线上的设备**相当于**虚拟PCI设备**. 在GMCH中, 并没有提到这个FSB\-to\-PCI桥, 但是**芯片设计上**, 存在这个**桥片的概念**.

从系统软件来看, 在**PCI总线0**上挂接的**设备**都含有**PCI配置寄存器(！！！**), **系统软件**将这些设备**看做PCI设备**, 并可以访问这些设备的**PCI配置空间**. 在Montevina平台的**GMCH和ICH**中, **所有的外部设备**, 如**存储控制器**, **图形控制器**等都是**虚拟PCI设备**, 都具有**独立的PCI配置空间**. **GMCH**和**ICH**之间**使用DMI(Direct Management Interface)接口**相连, 但是**DMI接口仅仅是链路级别的连接(！！！**), 并**不产生新的PCI总线号(！！！**), ICH的**DMI\-to\-USB桥**和**DMI\-to\-PCIe桥**也都属于**PCI总线0**上的**设备**.

注: 从体系结构角度看, MCH和ICH仅仅是一个称呼, 实际上并不重要.

在**x86处理器**中, **MCH**包含的**虚拟PCI设备优先级较高**, 而**ICH**包含的**虚拟PCI设备优先级低**. 当**CPU**发起一个**PCI数据请求**时, **MCH的PCI设备**将首先**在PCI总线0上进行正向译码**. 如果**当前PCI数据请求**所使用的**地址没有在MCH的PCI设备命中**时, **DMI接口部件**将使用**负向译码**方式**被动地接受这个数据请求**, 然后通过**DMI总线**将这个**数据请求转发到ICH(！！！**)中.

因此在**x86**中, **MCH**集成了一些**对宽带要求较高的虚拟PCI设备**, 如**DDR控制器**, **显卡**等. 而在**ICH**中集成了一些**低速PCIe端口**, 和一些**速度相对较低的外部设备**, 如**PCI\-to\-USB桥**, **LPC总线控制器**等.

**MCH**和**ICH**包含一些**内置的PCI设备**, 这些设备**都具于PCI配置空间**, x86处理器可以**使用PCI配置周期访问这些PCI配置空间**. 在**MCH**和**ICH**中, **PCI总线0**是**FSB总线的延伸**, 所以**处理器访问这些设备**时并**不使用PCI总线规定的信号**, 如FRAME\#, TRDY\#, IRDY\#和IDSEL信号. 在MCH和ICH中, 有些PCI设备并不是传统意义上的外部设备, 而仅是虚拟PCI设备, 即使用PCI总线的管理方法统一在一起的设备.

x86处理器使用这些**虚拟PCI外设**的优点是可以将所有外部设备都使用PCI总线统一起来, 这些**设备使用的寄存器**都可以**保存在PCI设备的配置空间**中, 但是使用这种方法在某种程度上容易混淆一些概念, 尤其是有关地址空间的概念. 例如在**处理器体系结构的典型定义**中, **DDR\-SDRAM空间**属于**存储器域**, 与其**相关的DDR\-SDRAM控制器**也应该属于**存储器域**, 但是在**x86处理器**中**存储器控制器属于PCI总线域**.