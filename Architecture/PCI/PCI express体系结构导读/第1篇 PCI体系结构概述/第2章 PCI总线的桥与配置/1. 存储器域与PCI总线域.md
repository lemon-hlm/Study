[TOC]

# 0 概述

**HOST主桥**的实现**因处理器系统而异(！！！**)。PowerPC处理器和x86处理器的HOST主桥除了**集成方式不同**之外，其**实现机制也有较大差异**。但是**这些HOST主桥**所完成的**最基本功能**依然是**分离存储器域与PCI总线域(！！！**)，完成**PCI总线域**到**存储器域**，**存储器域**到**PCI总线域**之间的**数据传递(！！！**)，并**管理PCI设备的配置空间(！！！**)。

上文曾经多次提到在**一个处理器系统**中，存在**PCI总线域**与**存储器域**，深入理解这**两个域的区别**是**理解HOST主桥的关键**所在。在一个处理器系统中，**存储器域**、**PCI总线域**与**HOST主桥**的关系如图2‑1所示。

![config](./images/1.png)

上图所示的**处理器系统**由**一个CPU**，**一个DRAM控制器**和**两个HOST主桥**组成。在这个处理器系统中，包含**CPU域**、**DRAM域**、**存储器域**和**PCI总线域地址空间**。其中**HOST主桥x**和**HOST主桥y**分别管理**PCI总线x域**与**PCI总线y域**。

**PCI设备访问存储器域时(！！！**)，也需要**通过HOST主桥**，并由**HOST主桥(！！！**)进行**PCI总线域**到**存储器域的地址转换**；**CPU访问PCI设备时(！！！**)，同样需要通过**HOST主桥**进行**存储器域**到**PCI总线域的地址转换(！！！**)。

**如果HOST主桥**支持**Peer\-to\-Peer传送**机制，**PCI总线x域**上的**设备**可以与**PCI总线y域**上的**设备直接通信(！！！**)，如PCI设备x11可以直接与PCI设备y11通信。为简化模型，在本书中，PCI总线仅使用32位地址空间。

# 1 CPU域、DRAM域与存储器域

## 1.1 CPU域

**CPU域地址空间**指**CPU所能直接访问的地址空间集合(！！！**)。在本书中，**CPU**、**处理器**与**处理器系统**的**概念不同(！！！**)。如MPC8548处理器的内核是E500 V2[1]，本书将这个**处理器内核称为CPU**；**处理器**由**一个或者多个CPU**、**外部Cache**、**中断控制器**和**DRAM控制器**组成；而**处理器系统**由**一个或者多个处理器**和**外部设备**组成。

在CPU域中有一个重要概念，即**CPU域边界**，所谓CPU域边界，即**CPU所能控制的数据完整性边界**。**CPU域的边界**由**Memory Fence指令**(**x86处理器的Memory Fence指令为MFENCE，LFENCE和SFENCE**，而PowerPC处理器的Memory Fence指令为msync和mbar)的**作用范围确定**，CPU域边界的划分对数据完整性(Data Consistency)非常重要。与CPU域相关的数据完整性知识较为复杂，可以独立出书，因此本篇对**数据完整性**不做进一步介绍。笔者有计划再更新完PCIe总线部分的资料后，书体系结构的两方面内容，一个是Cache层次结构，一个是以Weakly Ordered Memory Modle为基础书写数据完整性。

严格的讲**CPU域仅在CPU内核中有效(！！！**)，**CPU**访问**主存储器**时，首先将**读写命令**放入**读写指令缓冲(！！！**)中，然后将这个命令发送到**DRAM控制器(！！！**)或者**HOST主桥(！！！**)。**DRAM控制器**或者**HOST主桥**将**CPU地址**转换为**DRAM**或者**PCI总线地址(！！！**)，分别进入**DRAM域(！！！**)或者**PCI总线域(！！！**)后，再访问**相应的地址空间**。

## 1.2 DRAM域

**DRAM域地址空间**指**DRAM控制器所能访问的地址空间集合(！！！**)。目前处理器系统的**DRAM**一般由**DDR\-SDRAM**组成，有的书籍也将这部分内存称为主存储器。在**有些处理器系统**中，**DRAM控制器**能够访问的**地址空间**，并**不能被处理器访问**，因此在这类处理器系统中，CPU域与DRAM域地址空间并不等同。

比如**有些CPU**可以支持**36位的物理地址**，而**有些DRAM控制器**仅支持**32位的物理地址**，此时CPU域包含的地址空间大于DRAM域地址空间。但是这并不意味着DRAM域一定包含在CPU域中，在某些处理器系统中，CPU并不能访问在DRAM域中的某些数据区域。而**CPU域**中除了**包含DRAM域**外，还**包含外部设备空间(！！！**)。

在**多数处理器系统**中，**DRAM域空间**是**CPU域空间**的**一部分**，但是**也有例外**。比如**显卡控制器**可能会借用**一部分主存储器空间**，这些**被借用的空间不能被CPU访问**，而**只能被DRAM控制器**，更为准确地说是**显卡通过DRAM控制器访问(！！！**)，因此**这段空间不属于CPU域(！！！**)，严格地讲，**这段空间属于外部设备域(！！！**)。

## 1.3 存储器域

本书使用**存储器域统称CPU域与DRAM域(！！！**)。**存储器域**包括**CPU内部的通用寄存器**，**存储器映像寻址的寄存器**，**主存储器空间**和**外部设备空间**。在Intel的x86处理器系统中，**外部设备空间与PCI总线域地址空间等效(！！！**)，因为在**x86处理器系统**中，使用**PCI总线统一管理全部外部设备(！！！**)。为简化起见，本书使用**PCI总线域替代外部设备域(！！！**)。

值得注意的是，**存储器域的外部设备空间(！！！**)，在**PCI总线域**中还有一个**地址映射**。当**处理器**访问**PCI设备**时，**首先访问**的是**这个设备**在**存储器域**上的**PCI设备空间**，之后**HOST主桥**将这个存储器域的PCI总线地址转换为PCI总线域的物理地址(PCI总线域只含有物理地址, 因此下文将直接使用PCI总线地址, 而不适用PCI总线物理地址)，然后再通过PCI总线事务访问PCI总线域的地址空间。