
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

* [1. HOST主桥](#1-host主桥)
* [2. PCI总线](#2-pci总线)
* [3. PCI设备](#3-pci设备)
* [4. HOST处理器](#4-host处理器)
* [5. PCI总线的负载](#5-pci总线的负载)

<!-- /code_chunk_output -->

PCI总线作为处理器系统的局部总线，是处理器系统的一个组成部件，在一个处理器系统中，与PCI总线相关的模块如图1‑1所示。

![config](images/1.png)

如图1‑1所示在一个处理器系统中，与PCI总线相关的模块包括，HOST主桥、PCI总线、PCI桥和PCI设备。PCI总线由HOST主桥和PCI桥推出，HOST主桥与主存储器控制器在同一级总线上，PCI设备可以方便地通过HOST主桥访问主存储器，即进行DMA操作。

值得注意的是，PCI设备的DMA操作需要与处理器系统的Cache进行一致性操作，当PCI设备通过HOST主桥访问主存储器时，Cache一致性模块将进行地址监听，并根据监听的结果改变Cache的状态。

在一些简单的处理器系统中，可能不含有PCI桥，此时所有PCI设备都是连接在HOST主桥推出的PCI总线上，此外在一些处理器系统中可能含有多个HOST主桥，如在图1‑1所示的处理器系统中含有HOST主桥x和HOST主桥Y。

## 1. HOST主桥

HOST主桥是一个很特别的桥片，其主要功能是**隔离处理器系统的存储器域与处理器系统的PCI总线域**，管理PCI总线域，并完成**处理器与PCI设备间的数据交换**。处理器与PCI设备间的数据交换主要由“处理器访问PCI设备的地址空间”和“PCI设备使用DMA机制访问主存储器”这两部分组成。

**下文将处理器系统的存储器域简称为存储器域，而将处理器系统的PCI总线域称为PCI总线域**，存储器域和PCI总线域的详细介绍见第2.1节。值得注意的是，在一个处理器系统中，有几个HOST主桥，就有几个PCI总线域。

HOST主桥在处理器系统中的位置并不相同，如PowerPC处理器将HOST主桥与处理器集成在一个芯片中。而有些处理器不进行这种集成，如**x86处理器使用南北桥结构**，处理器内核在一个芯片中，而**HOST主桥在北桥中**。但是**从处理器体系结构的角度上看，这些集成方式并不重要**。

PCI设备通过HOST主桥访问主存储器时，需要与处理器的Cache进行一致性操作，因此在设计HOST主桥时需要重点考虑Cache一致性操作。在HOST主桥中，还含有许多数据缓冲，以支持PCI总线的预读机制。

**HOST主桥是联系处理器与PCI设备的桥梁**。在一个处理器系统中，**每一个HOST主桥都管理了一颗PCI总线树**，在**同一颗PCI总线树上的所有PCI设备属于同一个PCI总线域**。如图1‑1所示，HOST主桥x之下的PCI设备属于PCI总线x域，而HOST主桥y之下的PCI设备属于PCI总线y域。在这颗总线树上的所有PCI设备的配置空间都由HOST主桥通过配置读写总线周期访问。

如果**HOST主桥**支持PCI V3.0规范的Peer-to-Peer数据传送方式，那么**分属不同PCI总线域的PCI设备可以直接进行数据交换**。如图1‑1所示，如果HOST主桥y支持Peer-to-Peer数据传送方式，PCI设备y01可以直接访问PCI设备01或者PCI设备11，而不需要通过处理器的参与。但是这种**跨越总线域的数据传送方式在PC架构中并不常用**，在PC架构中，重点考虑的是PCI设备与主存储器之间的数据交换，而不是PCI设备之间的数据交换。此外在PC架构中，**具有两个HOST主桥的处理器系统也并不多见**。

在PowerPC处理器中，HOST主桥可以通过设置Inbound寄存器，使得分属于不同PCI总线域的设备可以直接通信。许多PowerPC处理器都具有多个HOST主桥，有关PowerPC处理器使用的HOST主桥详见第2.2节。

## 2. PCI总线

在处理器系统中，含有**PCI总线**和**PCI总线树**这两个概念。这两个概念并不相同，在一颗PCI总线树中可能具有多条PCI总线，而具有血缘关系的PCI总线组成一颗PCI总线树。如在图1‑1所示的处理器系统中，**PCI总线x树具有两条PCI总线，分别为PCI总线x0和PCI总线x1**。而**PCI总线y树中仅有一条PCI总线**。

**PCI总线由HOST主桥或者PCI桥管理**，用来连接各类设备，如声卡、网卡和IDE接口卡等。在一个处理器系统中，可以**通过PCI桥扩展PCI总线**，并形成具有血缘关系的多级PCI总线，从而形成PCI总线树型结构。在处理器系统中**有几个HOST主桥，就有几颗这样的PCI总线树，而每一颗PCI总线树都与一个PCI总线域对应**。

与HOST主桥直接连接的PCI总线通常被命名为PCI总线0。考虑到在一个处理器系统中可能有多个主桥，图1‑1将HOST主桥x推出的PCI总线命名为x0总线，而将PCI桥x1扩展出的PCI总线称之为x1总线；而将HOST主桥y推出的PCI总线称为y0~yn。**分属不同PCI总线树的设备，其使用的PCI总线地址空间分属于不同的PCI总线域空间**。

## 3. PCI设备

在PCI总线中有三类设备，**PCI主设备、PCI从设备和桥设备**。其中**PCI从设备只能被动地接收来自HOST主桥，或者其他PCI设备的读写请求；而PCI主设备可以通过总线仲裁获得PCI总线的使用权，主动地向其他PCI设备或者主存储器发起存储器读写请求。而桥设备的主要作用是管理下游的PCI总线，并转发上下游总线之间的总线事务**。

**一个PCI设备可以既是主设备也是从设备(！！！)，但是在同一个时刻，这个PCI设备或者为主设备或者为从设备**。PCI总线规范将PCI主从设备统称为PCI Agent设备。在处理器系统中常见的PCI网卡、显卡、声卡等设备都属于PCI Agent设备。

在PCI总线中，**HOST主桥是一个特殊的PCI设备**，该设备**可以获取PCI总线的控制权访问PCI设备，也可以被PCI设备访问**。但是**HOST主桥并不是PCI设备。PCI规范也没有规定如何设计HOST主桥**。

在PCI总线中，还有一类特殊的设备，即**桥设备**。桥设备包括**PCI桥（PCI-to-PCI桥）、PCI-to-(E)ISA桥和PCI-to-Cardbus桥**。本篇重点介绍PCI桥，而不关心其他桥设备的实现原理。PCI桥的存在使PCI总线极具扩展性，处理器系统可以使用PCI桥进一步扩展PCI总线。

PCI桥的出现使得采用PCI总线进行大规模系统互连成为可能。但是**在目前已经实现的大规模处理器系统中，并没有使用PCI总线进行处理器系统与处理器系统之间的大规模互连**。因为PCI总线是一个以HOST主桥为根的树型结构，使用主从架构，因而不易实现多处理器系统间的对等互连。

即便如此PCI桥仍然是PCI总线规范的精华所在，掌握**PCI桥是深入理解PCI体系结构的基础**。**PCI桥可以连接两条PCI总线，上游PCI总线和下游PCI总线(PCI总线x0和PCI总线x1)**，这两个PCI总线属于同一个**PCI总线域(PCI总线树)**，使用PCI桥扩展的所有PCI总线都同属于一个PCI总线域。

其中对**PCI设备配置空间的访问**可以从**上游总线转发到下游总线**，而数据传送可以双方向进行。在PCI总线中，还存在一种**非透明PCI桥**，该桥片不是PCI总线规范定义的标准桥片，但是适用于某些特殊应用，本篇将在第2.5节中详细介绍这种桥片。在本书中，如不特别强调，PCI桥是指透明桥，**透明桥也是PCI总线规范定义的标准桥片**。

PCI-to-(E)ISA桥和PCI-to-Cardbus桥的主要作用是通过PCI总线扩展(E)ISA和Cardbus总线。在PCI总线推出之后，(E)ISA总线并没有在处理器系统中立即消失，此时需要使用PCI-(E)ISA桥扩展(E)ISA总线，而使用PCI-to-Cardbus桥用来扩展Cardbus总线，本篇并不关心(E)ISA和Cardbus总线的设计与实现。

## 4. HOST处理器

PCI总线规定在**同一时刻内，在一颗PCI总线树上有且只有一个HOST处理器**。这个HOST处理器可以通过HOST主桥，发起PCI总线的配置请求总线事务，并对PCI总线上的设备和桥片进行配置。

在PCI总线中，HOST处理器是一个较为模糊的概念。在SMP(symmetric multiprocessing)处理器系统中，所有CPU都可以通过HOST主桥访问其下的PCI总线树，**这些CPU都可以作为HOST处理器**。但是值得注意的是，**HOST主桥才是PCI总线树的实际管理者，而不是HOST处理器**。

**在HOST主桥中，设置了许多寄存器，HOST处理器通过操作这些寄存器管理这些PCI设备**。如在x86处理器的HOST主桥中设置了0xCF8和0xCFC这两个I/O端口**访问PCI设备的配置空间**，而PowerPC处理器的HOST主桥设置了CFG\_ADDR和CFG\_DATA寄存器访问PCI设备的配置空间。值得注意的是，在PowerPC处理器中并没有I/O端口，因此使用存储器映像寻址方式访问外部设备的寄存器空间。

```
[root@CentOS7 ~]# cat /proc/ioports | grep PCI
0000-03bb : PCI Bus 0000:00
03bc-03df : PCI Bus 0000:00
03e0-0cf7 : PCI Bus 0000:00
0cf8-0cff : PCI conf1
1000-7fff : PCI Bus 0000:00
  2000-2fff : PCI Bus 0000:02
8000-ffff : PCI Bus 0000:80
```

## 5. PCI总线的负载

PCI总线的所能挂接的负载与总线频率相关，其中总线频率越高，所能挂接的负载越少。下文以 PCI总线和PCI-X总线为例说明总线频率、峰值带宽和负载能力之间的关系，如表1‑1所示。

![config](images/2.png)

由表1‑1所示，PCI总线频率越高，所能挂接的负载越少，但是整条总线所能提供的带宽越大。值得注意的是，PCI-X总线与PCI总线的传送协议略有不同，因此66MHz的PCI-X总线的负载数较大，PCI-X总线的详细说明见第1.5节。当PCI-X总线频率为266MHz和533MHz时，该总线只能挂接一个PCI-X插槽。在PCI总线中，一个插槽相当于两个负载，接插件和插卡各算为一个负载，在表1‑1中，33MHz的PCI总线可以挂接4\~5个插槽，相当于直接挂接8\~10个负载。