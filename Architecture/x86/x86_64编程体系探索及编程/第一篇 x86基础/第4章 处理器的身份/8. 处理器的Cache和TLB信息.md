**CPUID.EAX=02H**用来获得关于**CPU的Cache与TLB信息**。

```assembly
mov eax，02H        ;02号功能
cpuid
```

返回信息中**eax寄存器**的**最低字节（byte 0**）是需要**执行CPUID.EAX=02H的次数(！！！**)。

![config](./images/19.png)

上面这个最低字节的值为01，表明**只需要执行一次CPUID.EAX=02H**就能获得**完整的信息**。

>寄存器的MSB（Bit31）位是个标志位，为**0指示有效**，为**1指示无效**。

**eax、ebx、ecx和edx寄存器**中的**每个字节指示一个信息**（除EAX寄存器的byte 0外）。

![config](./images/20.png)

如果是**FF字节**表示CPUID.EAX=02H**不返回cache及TLB信息**，需要执行**CPUID.EAX=04H**进行查询。

>实验4-6：使用CPUID.EAX=02H查看cache及TLB信息

实验的源码在\topic04\ex4-6\setup.asm中，下面是在VMware中的运行结果。

![config](./images/21.png)

上面的信息是在VMware下打印出来的，从这个结果，我们可以看出来以下信息。

![config](./images/22.png)

处理器的**Cache和TLB**情况也可以**从CPUID.EAX=04H里获得**，04H功能号是**一个功能集**，以**ECX输入一个子叶号**，枚举出处理器**Cache的所有信息**。

首先以**ECX=0H子叶开始查询**，在**eax寄存器返回**，我们所关心的是以下几个位域。

![config](./images/23.png)

EAX[4：0]返回**cache的类型**，分别是：1=**Data cache**，2=**Instruction cache**，3=**Unified cache**，0值是**终止标志**，表示已经没有子叶可以枚举了，其他值是保留的。

EAX[7：5]返回**cache的level(！！！**)，EAX[31：26]域里也可以查询得到**处理器的core数**，这个查询结果值需要**加上1**才是真正的值。

接下来EBX寄存器的返回信息是：EBX[11：00]是**line size**，EBX[21：12]是**physical line partition**，EBX[31：22]返回**cache的way数**。最后ECX寄存器返回32位的**cache set数量**。

>实验4-7：使用CPUID.EAX=04H/ECX=n来查看cache及TLB信息

下面是部分代码片断，完整的源码在topic04\ex4-7\setup.asm里。

代码清单4-4：

```assembly
@@1：
mov ecx，[sub_leaves]       ;子叶号
mov esi，ecx
mov di，value_address
call get_hex_string
mov si，msg
call puts
mov si，value_address
call puts
mov si，msg2
call puts
mov eax，04                 ;探测 ECX=n
cpuid
mov [eax_value]，eax        ;保存各个寄存器的值
mov [ebx_value]，ebx
mov [ecx_value]，ecx
mov [edx_value]，edx
inc dword [sub_leaves]      ;下一个子叶号
call print_cache_info       ;打印信息
test eax，eax
jnz @@1
```

从**子叶ECX=0H**开始进行探测，直至EAX[4：0]为0（表示**没有下一个子叶**），**每一个子叶**得到的cache size的计算方法如下。

>cache size=line size × line partition × way × set

也就是等于：（EBX[11：00]+1）\*（EBX[21：12]+1）\*（EBX[31：22]+1）\*（ECX+1）。

**每一项加上1**，是因为返回的信息加上1才是完整的值。这个计算的过程在print\_cache\_info()过程里，读者可以在topic04\ex4-7\setup.asm源码里看到。下面是在VMware中的运行结果。

![config](./images/24.png)

对比一下上面的运行结果和使用CPUID.EAX=02H查询到的结果，看是否一致。上面的结果是：

1级Data\-cache的size是32KB（值为0x8000），8\-way 64 set结构。1级Instruction\-cache的size同样是32KB（值为0x8000），4-way 128 set结构。2级cache的size是256KB（值为0x40000），8-way 512 set结构。3级cache的size是3MB（值为0x300000），属于12-way 4096 set结构。

对比结果cache size和cache结构是一样的，在这个例子里没有完整打印详细的信息，读者朋友可以自行加入更完整的显示。这个例子探测到子叶号ECX=03H为止，ECX=04H已经不支持了。

让人感到沮丧的是：在AMD的机器上并不支持EAX=02H到EAX=04H的功能号！

是的，这确实让人反感，在AMD的机器上basic功能号支持EAX=01H、EAX=05H、EAX=06H以及EAX=0DH，这4个功能号。可是AMD比Intel支持更多的extended功能号，根据AMD的CPUID specification指示，最多达到了8000001EH，而Intel只支持到80000008H。

在AMD机器上可以使用80000005H、80000006H，以及8000001DH扩展功能号查询cache和TLB的相关信息。