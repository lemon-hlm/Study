[TOC]

# 0 概述

处理器提供了三类Debug Register以支持调试功能。

① 断点寄存器：DR0、DR1、DR2及DR3。

② 状态寄存器：DR6。

③ 控制寄存器：DR7。

这些debug寄存器的读/写使用MOV指令进行。

```assembly
mov DR0，0x200000             ； 设置断点1
```

上面这条mov指令将0x200000值写入DR0，用来设置其中一个断点地址。debug寄存器属于特权级资源，需要在CPL=0权限下进行读/写。

## 0.1 DR4和DR5寄存器

这两个寄存器是保留的，当CR4.DE=1时，访问DR4和DR5将会产生#UD异常。当CR4.DE=0时，访问DR4和DR5寄存器的结果将是对DR6和DR7的访问。

# 1 断点寄存器DR0～DR3

4个断点寄存器DR0、DR1、DR2及DR3用来设置断点的线性地址。

![config](./images/3.png)

在64位模式下，DR0～DR3寄存器是64位宽，保存64位的线性地址。

# 2 状态寄存器DR6

状态寄存器有一个：DR6寄存器。

![config](./images/4.png)

DR6寄存器反映最后一次发生#DB异常时的状态，这些状态位记录着最后一次由哪些条件引发#DB异常。只有当再一次发生#DB异常时，DR6寄存器的状态才会更新。
B0～B3标志位
B0～B3标志位被置位时，指示处理器在执行指令时遇到了DR0～DR3寄存器所设置的断点地址而引发#DB异常。例如：当B0被置位时，表示DR0寄存器内的断点被触发。
BD标志位
当DR7.GD=1时，对任何一个debug寄存器的访问（读或写）都会引发#DB异常。此时DR6.BD将会被置位，指示下一条指令是对debug寄存器的访问。
BS标志位
当由Eflags.TF标志位置位而引发Single-Step调试时，DR6.BS将被置位，指示发生了single-step调试。
BT标志位
在使用TSS进行任务切换时，由TSS块内的T标志置位而引发Trap调试时，DR6.BT将被置位，指示在任务切换时发生了Trap（#DB异常）。
多个debug条件同时触发
在DR6寄存器记录的多个debug条件可能会遇到同时触发的情形，读取DR6寄存器内容可以得到多个标志位被置位。
EFLAGS.RF标志位
当遇到Fault类型的debug异常发生时，EFLAGS寄存器的RF标志位将起重要的作用。此时需要对RF置位，让发生debug异常的指令得到成功执行（对Trap类型的#DB异常无影响）。
13.3.3 控制寄存器DR7
debug异常发生的允许条件由DR7寄存器进行控制，如下图所示。
[插图]
除了DR6寄存器中记录的BS（single-step）和BT（task switch，即由TSS内的T标志引发）debug异常外，其他类型的debug发生都可以在DR7里开启。
L0～L3（local breakpoint enable）控制位
对应于DR0～DR3这4个断点寄存器。当被置位时，允许对DR0～DR3中设置的断点地址访问时发生#DB异常（包括数据断点和执行断点）。
当发生task switch时，处理器会对L0～L3控制位清位，以防止在新任务里受原任务的影响而产生#DB异常。
G0～G3（global breakpoint enable）控制位
意义与L0～L3控制位一致，不同的是，在发生task switch时，处理器会保持原任务的G0～G3控制位有效，不会进行清位处理。
处理器检测到L0～L3或G0～G3中任何一个被置位，对应的DR0～DR3寄存器的断点被访问都会引发#DB异常。
举例说，无论是G0=1还是L0=1，在DR0寄存器中的断点地址被访问（在符合产生#DB异常的条件下）都会产生#DB异常。
GE与LE控制位
这两个控制位在P6家族以后的处理器不支持，Intel推荐这两个位设为1以兼容旧处理器。
GD（general detect enable）控制位
当DR7.GD=1时，对任何一个debug寄存器的访问都会产生#DB异常。处理器在进入#DB handler前会将GD清位，这将允许在#DB handler内访问debug寄存器。
GD控制位的设立是为了给emulator（模拟器）使用，在emulator里面的guest系统需要设置debug寄存器时，emulator可以对真实机器里的DR7.GD进行置位，让emulator产生#DB异常，在#DB handler里进行相关的处理。
DR7.GD用于避免emulator里的guest系统影响到真实机器里的debug寄存器。
按笔者的理解，这里所说的emulator应该是指VMware这类虚拟机软件，但应该不包括Bochs这类模拟器。
R/W0～R/W3（read/write）控制位
这4个域用来设置对DR0～DR3寄存器里的断点地址所进行访问的类型，可以包括：
① 00B：对断点地址fetch指令（即执行断点里的指令）。
② 01B：对断点地址进行Write操作（仅限于写）。
③ 10B：对I/O地址进行Read和Write操作。此时对应的DR0～DR3寄存器保存的是I/O地址。
④ 11B：对断点地址进行Read和Write操作。
在上面的（3）里，需要开启CR4.DE（Debug Extension）控制位。当CR4.DE=0时，10B值是未定义的设置。注意（2）与（4）的区别，01B仅限于写操作，11B可以包括读操作。
LEN0～LEN3（Length）控制位
这4个域用来设置DR0～DR3寄存器的断点地址有效范围，如下所示。
① 00B：byte（1个字节）。
② 01B：word（2个字节）。
③ 10B：quad word（8个字节）。
④ 11B：double word（4个字节）。
上面的（3），使用在IA-32e模式（long-mode）里，否则是未定义的设置。
13.3.4 Fault与Trap类型的debug异常
#DB异常可以是Fault或者Trap类型，下面两类条件引发的#DB异常属于Fault类型。
① DR7.GE=1时，对debug寄存器的访问引发#DB异常。
② 对断点指令的执行引发#DB异常。
下面条件引发的#DB异常属于Trap类型。
① Eflags.TF=1时引发的single-step #DB异常。
② 由task switch时TSS段里的TF置位而引发的#DB异常。
③ 对断点地址的访问引发的#DB异常。
④ 对I/O地址的访问引发的#DB异常。
Fault类型的debug异常在引发异常的指令执行之前产生，而Trap类型的debug异常在引发异常的指令执行完后产生。