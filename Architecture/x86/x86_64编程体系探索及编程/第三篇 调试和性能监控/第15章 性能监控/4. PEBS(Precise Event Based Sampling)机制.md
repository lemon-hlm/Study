[TOC]

PEBS直译为基于抽样的精确事件。开启PEBS机制允许当发生PEBS中断时在内存DS存储区域的PEBS buffer里保存处理器的context环境。
检测PEBS机制是否可用
由于PEBS机制是建立在DS（Debug Store）存储区域之上的，在检测PEBS是否可用时还需要先检测处理器是否支持DS机制。
在lib\debug.asm文件里实现了一个检测函数available_pebs（），如下。
代码清单15-10（lib\debug.asm）：

；---------------------------------
； available_pebs（）：是否支持 PEBS 机制
； output：
；  1-available，0-unavailable
；--------------------------------------
available_pebs：
      mov eax，1
      cpuid
      bt edx，21     ； Debug Store支持位
      setc al
      jnc available_pebs_done
      mov ecx，IA32_MISC_ENABLE
      rdmsr
      bt eax，12     ； PEBS unavailable 位
      setnc al
available_pebs_done：
      movzx eax，al
      ret
代码先通过CPUID.01：EDX[21]位来检测是否支持DS（Debug Store）功能，IA32_MISC_ENABLE寄存器的bit 12位是PEBS unavailable位，置位时表示unavailable（不可用的），为0时表示available（可用的）。
15.4.1 PEBS buffer
PEBS buffer与BTS buffer共同组成DS（Debug Store）存储区域里的buffer记录区，因此与BTS buffer一样，在设置PEBS buffer结构前需要检测PEBS记录的格式。
64位的PEBS记录格式
当软件检测到CPUID.01：ECX[2].DTES64位为1时，表示固定使用64位的PEBS记录格式，而无论是否开启64位模式。
代码清单15-11（lib\debug.asm）：

；------------------------------------
； support_ds64：查询是否支持 DS save 64 位格式
； output：
；  1-support，0-no support
；-----------------------------------
support_ds64：
      mov eax，1
      cpuid
      bt ecx，2    ； DEST64 位
      setc al
      movzx eax，al
      ret
这个函数在14.9.2节我们已经见过。当支持DS64格式时，BTS记录与PEBS记录都使用64位格式。
增强的PEBS记录格式
从Nehalem架构开始，处理器支持增强的PEBS记录格式，因此我们可以认为这个是增强的64位记录格式，因为它已经支持DS64格式了。
[插图]
上图已经归纳了三种PEBS记录格式：32位与64位的PEBS记录格式，以及增强的64位PEBS记录格式。增强的PEBS记录格式里额外增加了4个域。
[插图]
这些域在普通的PEBS记录格式里是保留位。偏移量90H的IA32_PERF_GLOBAL_STATUS寄存器值是发生PMI前的值，其余3个值使用在增强功能里。
IA32_PERF_CAPABILITIES寄存器
PEBS机制的一些额外功能可以从IA32_PERF_CAPABILITIES寄存器里获得，这个寄存器需要通过CPUID.01：ECX[15].PDCM位来获得支持，代码如下。

      mov eax，1
      cupid
      bt ecx，15    ； PDCM 位
      jnc no_support
      …      ； 支持
no_support：
      … …      ； 不支持
IA32_PERF_CAPABILITIES寄存器中一些标志位指示了LBR与PEBS的格式，这个寄存器的结构如下所示。
[插图]
IA32_PERF_CAPABILITES寄存器是只读寄存器，这表示寄存器读出来的值就固定了PEBS的某些功能不能更改。
这个寄存器的FW_WRITE（bit13）位指示了IA32_PMCx与IA32_FIXED_CTRx计数器是否可写入全部宽度，详情请参考前面的15.2.3节所述。在SandyBridge架构之前处理器不允许写入全部full-width（例如：48位值）。
LBR_FMT域（bit5到bit0）指示了LBR stack中LBR记录的格式。详情请参考14.4节的相关描述。
PEBS_REC_FMT（bit11到bit8）指示了PEBS记录的额外格式，目前该域只有两个值供选择。
① 0000B：使用普通的格式，保存EFLAGS寄存器，EIP/RIP寄存器，以及8个通用寄存器或者16个通用寄存器（64位模式下）。
② 0001B：使用增强的PEBS记录格式，在原PEBS记录格式的基础上增加额外的4个域。
软件通过检测IA32_PEF_CAPABILITIES寄存器的PEBS_REC_FMT域来确定是否支持增强PEBS记录格式，如下面代码所示。
代码清单15-12（lib\debug.asm）：

；------------------------------------------------------------
； support_enhancement_pebs（）：检测是否支持增强的 PEBS 记录
； output：
； 1-support，0-no support
；-----------------------------------------------------------
support_enhancement_pebs：
      mov ecx，IA32_PERF_CAPABILITIES
      rdmsr
      shr eax，8
      and eax，0Fh    ； 得到 IA32_PREF_CAPABILITIES[11：8]
      cmp eax，0001B    ； 测试是否支持增强的 PEBS 格式
      sete al
      movzx eax，al
      ret
