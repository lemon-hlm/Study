- 1 32位分页
    - 1.1 4KB页面线性地址翻译
    - 1.2 4MB页面线性地址翻译
    - 1.3 CR3和分页结构项
- 2 PAE分页
    - 2.1 4KB页面线性地址翻译
    - 2.2 2MB页面线性地址翻译
    - 2.3 CR3和分页结构项
- 3 IA\-32e分页
    - 3.1 4KB页面线性地址翻译
    - 3.2 2MB页面线性地址翻译
    - 3.3 1GB页面线性地址翻译
    - 3.4 CR3和分页结构项
- 4 分页错误代码

https://blog.csdn.net/Firas/article/details/17207813

翻译自《Intel® 64 and IA\-32 Architectures Software Developer Manuals》

![config](./images/40.png)

每个table里的entry（表项）分别被称为PTE（Page Table Entry）、PDE（Page Directory Table Entry）、PDPE（Page Directory Pointer Table Entry）和PML4E（Page\-Map Leve\-4 Table Entry）。

# 1 32位分页

**线性地址是32位宽**, 采用一级或两级页转换表, 每个表项大小是4字节宽, CR3使用32位.

## 1.1 4KB页面线性地址翻译

使用PDT（page directory table，页目录表）和PT（page table，页表）两级表格。

用32位分页的到一个4KB页面的线性地址翻译

![config](./images/1.jpg)

**4KB页面线性地址构成: 10(PDT索引, 1024个项) \+ 10(PT索引, 1024个项) \+ 12(Page offset, 4KB页**)

**一个PDT和一个PT大小都是4KB**. 

## 1.2 4MB页面线性地址翻译

使用PDT（page directory table）一级表格。

用32位分页的到一个4MB页面的线性地址翻译

![config](./images/2.jpg)

**4MB页面线性地址构成: 10(PDT索引, 1024个项) \+ 22(Page offset, 4MB页**)

**一个PDT大小是4KB**

## 1.3 CR3和分页结构项

32位分页的CR3和分页结构项的格式

![config](./images/3.jpg)

## 1.4 物理地址组成

32位paging下**最高为40位物理地址(！！！**)（依赖于**PSE\-36**与**MAXPHYADDR**值）。

### 1.4.1 PDT物理基地址

在32位paging模式下，CR3使用**低32位**（在**Intel64或AMD64机器上64位, 只使用低32位！！！**），CR3的**Bit 31到Bit 12位**提供**20位的Page Directory Table的物理基地址(物理基地址！！！高20位！！！**)。那么以**36位的物理基地址**为例，它是这样形成的。

① base of PDT[35：32]=0值（**高4位Bit 35到Bit 32为0值！！！如果是40位物理地址高位也会是补0！！！**）。

② base of PDT[31：12]=CR3[31：12]（**中间20位**由**CR3的Page Driectory base域**提供）。

③ base of PDT[11：00]=0值（**低12位补0！！！**）。

因此CR3提供的**PDT物理基地址(！！！**)是**4K边界对齐(！！！**)的。**和4KB分页的物理地址形成方式一致(！！！**).

### 1.4.2 4KB页面的

### 1.4.2 4MB页面的物理基地址

**4MB页面**的**PDE结构**提供**4MB页面的物理基地址**, 地址组成方式如下:

① 当处理器**不支持PSE\-36**功能时，4M page frame只能映射到**32位的物理地址空间(！！！**)上，PDE\[31: 22\]是4M page base\[31: 22\](**高10位**), 这时候**PDE[21：13]共9位是保留位**，必须设置为0值。

② 当**MAXPHYADDR**值为**36**位时，PDE\[16：13\]是**4M page base[35：32]位(高4位**)，PDE\[31: 22\]是4M page base\[31: 22\](**中间10位**), 而PDE\[21：17\]是保留位，必须设置为0值。

③ 当MAXPHYADDR值为**40位**时，PDE[20：13]是**4M page base\[39：32\]位(高8位**), PDE\[31: 22\]是4M page base\[31: 22\](**中间10位**)，而PDE[21]位是保留位，必须设置为0值。

④ 当MAXPHYADDR值为**52位**时，也**仅能使用40位的物理地址(！！！**)，同3）。

因此，4M page frame的基地址形成除上述所说外，**36位或40位的物理地址低22位将补0(！！！**)，物理页面将在**4M边界上对齐(！！！**)。

# 2 PAE分页

线性地址32位宽, 使用两级或三级页转换表, 每个表项8字节宽, 新CR3使用了27位, 拼凑了32位PDPT物理地址。

## 2.1 4KB页面线性地址翻译

使用PDPT（page directory pointer table，页目录指针表），PDT和PT。

用PAE分页的到一个4KB页面的线性地址翻译

![config](./images/4.jpg)

**4KB页面线性地址构成: 2(PDPT索引, 4个项) \+ 9(PDT索引, 512个项) \+ 9(PT索引, 512个项) \+ 12(Page offset, 4KB页**)

**PDPT大小可以是4x8=32字节**, PDT和PT仍然是4KB大小, 512x8.

## 2.2 2MB页面线性地址翻译

使用PDPT和PDT。

用PAE分页的到一个2MB页面的线性地址翻译

![config](./images/5.jpg)

**2MB页面线性地址构成: 2(PDPT索引, 4个项) \+ 9(PDT索引, 512个项) \+ 21(Page offset, 2MB页**)

**PDPT大小可以是4x8=32字节**, PDT是4KB

## 2.3 CR3和分页结构项

![config](./images/6.jpg)

# 3 IA\-32e分页

线性地址48位宽, 使用两级到四级的页转换表, 每个表项都是8字节宽, CR3是64位宽, 针对是否支持PCIDE功能, CR3使用不一样。

## 3.1 4KB页面线性地址翻译

使用PML4T（page map level-4 table，四层映射表），PDPT，PDT和PT。

用IA\-32e分页的到一个4KB页面的线性地址翻译

![config](./images/7.jpg)

**4KB页面线性地址构成: 9(PML4T索引, 512个项) \+ 9(PDPT索引, 512个项) \+ 9(PDT索引, 512个项) \+ 9(PT索引, 512个项) \+ 12(Page offset, 4KB页**)

每个table(PML4T, PDPT, PDT, PT)大小都是4KB = 512x8

## 3.2 2MB页面线性地址翻译

使用PML4T，PDPT和PDT。

用IA\-32e分页的到一个2MB页面的线性地址翻译

![config](./images/8.jpg)

**2MB页面线性地址构成: 9(PML4T索引, 512个项) \+ 9(PDPT索引, 512个项) \+ 9(PDT索引, 512个项) \+ 21(Page offset, 2MB页**)

每个table(PML4T, PDPT, PDT)大小都是4KB = 512x8

## 3.3 1GB页面线性地址翻译

使用PML4T和PDPT。

用IA\-32e分页的到一个1GB页面的线性地址翻译

![config](./images/9.jpg)

**1GB页面线性地址构成: 9(PML4T索引, 512个项) \+ 9(PDPT索引, 512个项) \+ 30(Page offset, 1GB页**)

每个table(PML4T, PDPT, PDT)大小都是4KB = 512x8

## 3.4 CR3和分页结构项

IA\-32e分页的CR3和分页结构项的格式

![config](./images/10.jpg)

# 4 分页错误代码

![config](./images/11.jpg)