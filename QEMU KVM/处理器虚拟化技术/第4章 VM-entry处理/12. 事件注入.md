[TOC]

MSR-load列表成功加载完毕(如果需要加载), 代表在整个VM\-entry操作流程里, 处理器在host端的工作已经完成, 当前处理器已经成功转入guest端的运行环境.

如果存在"事件注入"或"pending debug exception", 它们将是VM\-entry完成后处理器在guest环境里的第1个需要执行的任务. 多数情况下, 事件注入或pending debug exception是虚拟化guest端产生事件的一种手段, 但也可以是host主动让guest执行额外的工作.

VM\-entry interruption information字段的bit 31为1时, 取决于该字段的设置(见3.6.3节与4.4.3.3节), 有下面的事件注入:

- 外部中断(类型为0), NMI(类型为2), 硬件异常(类型为3), 软件中断(类型为4), 特权级软件中断(类型为5)以及软件异常(类型为6)
- **pending MTF VM\-exit事件**: 中断类型为7, 并且向量号为0.

这些注入的事件属于"**向量事件**", 当VM\-entry伴随着一个事件注入时, 这样的VM\-entry被称为"**向量化的VM\-entry**". 由于事件注入是**VM\-entry完成**后**guest第1个需要执行的任务**, 所有有很高的优先级. **guest环境**下**当前的IDTR寄存器**已经被加载(见4.7.5.2节), 表示**guest端的IDT已经建立**. 这个向量事件将**通过guest IDT进行deliver执行(！！！**).

## 0.1 pending MTF VM\-exit事件

VMX架构允许注入一个不执行任何代码的事件. 中断类型为7并且向量号为0时, 注入一个MTF VM\-exit事件pending在guest的第1条指令前, VM\-entry操作完切换到guest环境后**立即产生VM\-exit**. 注入的pending MTF VM\-exit事件不受processor\-based VM\-execution control字段的"monitor tap flag"位影响, 即使"monitor trap flag"为0.

## 0.2 向量事件的注入点

在**guest执行注入的事件**前guest的运行环境已经被建立. **当前的CS:RIP(指令指针**), **SS:RSP(栈指针**)以及**RFLAGS值已经从guest\-state区域(！！！**)相应的字段里加载.

**RIP**指向VM\-entry后**guest端第1条指令**的位置, **向量事件**被**pending在guest的第1条指令前(！！！**). 因此, 注入事件在guest第1条指令之前被deliver执行.

如图, guest执行**INT3指令**由于**exception bitmap字段bit 3为1**而**产生VM\-exit(！！！**), **VMM注入\#BP异常**恢复**guest执行**(必须在VM\-entry instruction length字段里提供**指令长度！！！**). \#BP异常在**guest第1条指令(即INT3)前被deliver执行(！！！**). 处理器在**deliver \#BP异常期间压入的返回值**等于**guest\-RIP加上指令长度**(也就是\#BP handler返回**会跳过INT3指令**)

![config](./images/1.png)

假如**开启分支记录功能**来**监控注入事件的delivery情况**, 可以看到**事件delivery源地址**是**guest第1条指令**,**目标地址**是**注入事件的服务例程入口地址**. **IRET指令**返回的**目标地址**是**guest第1条指令地址**(图中就是**INT3的下一条指令**).

从guest执行流程看, 注入的事件本质上相当于"VM\-entry后guest第1条指令前产生一个向量事件". 取决于事件的类型, 有下面几种情况:

- 注入**硬件异常事件(0\~31之间的**)时, 相当于**引发一个异常**.
- 注入**外部中断或NMI**时, 相当于遇到了一个**外部中断或NMI请求**.
- 注入**软件中断**或特权级软件中断时, 相当于插入了一条INT指令.
- 注入软件异常时, 相当于插入了一条INT3或INTO指令.

## 0.3 fault与trap类型事件

在guest里, 一个向量事件直接或间接引发VM\-exit后, VMM需要在VM-entry时通过注入事件的方式让guest完成向量事件的处理.

引用对异常的分类方法, 按照事件处理后恢复的执行点不同, 可以将向量事件分为以下两大类:

- fault类型: 指硬件异常(不包括由单步调试产生的\#DB异常), 外部中断和NMI.
- trap类型: 指软件异常(\#BP与\#OF, 执行INT3与INTO指令产生), 软件中断(执行INT指令)和特权级软件中断(事件注入方式)

