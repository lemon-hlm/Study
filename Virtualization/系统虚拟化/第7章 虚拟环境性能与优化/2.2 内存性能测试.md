
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

* [1 内存性能测试工具](#1-内存性能测试工具)

<!-- /code_chunk_output -->

# 1 内存性能测试工具

**内存密集型**的应用程序分别在非虚拟化的原生系统和KVM客户机中运行，然后**根据它们的运行效率**就可以**粗略评估KVM的内存虚拟化性能**。

对于**内存**的性能测试，可以选择10.2.1节中提到的SPECjbb2015、SysBench、内核编译等基准测试（因为它们同时也是内存密集型的测试），还可以选择LMbench、Memtest86+、STREAM等测试工具。下面简单介绍几种内存性能测试工具。

1.LMbench
LMbench是一个使用GNU GPL许可证发布的免费和开源的自由软件，可以运行在类UNIX系统中，以便比较它们的性能，其官方网址是：http://www.bitmover.com/lmbench。LMbench是一个用于评价系统综合性能的可移植性良好的基准测试工具套件，它主要关注两个方面：带宽（bandwidth）和延迟（latency）。LMbench中包含了很多简单的基准测试，它覆盖了文档读写、内存操作、管道、系统调用、上下文切换、进程创建和销毁、网络等多方面的性能测试。
另外，LMbench能够对同级别的系统进行比较测试，反映不同系统的优劣势，通过选择不同的库函数我们就能够比较库函数的性能。更为重要的是，作为一个开源软件，IMbench提供一个测试框架，假如测试者对测试项目有更高的测试需要，能够修改少量的源代码就达到目的（比如现在只能评测进程创建、终止的性能和进程转换的开销，通过修改部分代码即可实现线程级别的性能测试）。
2.Memtest86+
Memtest86+是基于由Chris Brady所写的著名的Memtest86改写的一款内存检测工具，其官方网址为：http://www.memtest.org。该软件的目标是提供一个可靠的软件工具，进行内存故障检测。Memtest86+同Memtest86一样是基于GNU GPL许可证进行开发和发布的，它也是免费和开源的。
Memtest86+对内存的测试不依赖于操作系统，它提供了一个可启动文件镜像（如ISO格式的镜像文件），将其烧录到软盘、光盘或U盘中，然后启动系统时就从软驱、光驱或U盘中的Memtest86+启动，之后就可以对系统的内存进行测试。在运行Memtest86+时，操作系统都还没有启动，所以此时的内存基本上是未使用状态（除了BIOS等可能占用了小部分内存）。一些高端计算机主板甚至将Mestest86+默认集成到BIOS中。
3.STREAM
STREAM是一个用于衡量系统在运行一些简单矢量计算内核时能达到的最大内存带宽和相应的计算速度的基准测试程序，其官方网址为：http://www.cs.virginia.edu/stream。STREAM可以运行在DOS、Windows、Linux等系统上。另外，STREAM的作者还开发了对STREAM进行扩充和功能增强的工具STREAM2，可以参考其主页：http://www.cs.virginia.edu/stream/stream2。
本节对KVM内存虚拟化性能的测试，使用了STREAM这个基准测试工具。
10.3.2　测试环境配置
对KVM的内存虚拟化性能测试的测试环境配置与10.2.2节的环境配置基本相同，具体可以参考表10-1和表10-2。
宿主机中启动客户机的命令也与10.2.2节相同。

qemu-system-x86_64 -enable-kvm -cpu host -smp cpus=4,cores=4,sockets=1 -m 16G -drive file=./rhel7.img,format=raw,if=virtio,media=disk -drive file=./raw_disk.img,format=raw,if=virtio,media=disk -device virtio-net-pci,netdev=nic0 -netdev bridge,id=nic0,br=virbr0 -daemonize -name perf_test -display vnc=:1

值得注意的是，本次测试的Intel平台是支持EPT和VPID的，对于内存测试，只要硬件支持，KVM也默认使用了EPT、VPID。EPT和VPID（特别是EPT）对KVM中内存虚拟化的加速效果是非常明显的，所以要保证能使用它们（可参考5.3.2节）。
10.3.3　性能测试方法
本节选取STREAM工具来进行内存的性能测试，分别在原生系统和KVM客户机系统中执行STREAM基准测试，然后对比各项测试的得分即可评估KVM内存虚拟化的性能。
1.下载STREAM
从其官方网址https://www.cs.virginia.edu/stream/FTP/Code/下载STREAM测试程序，截至笔者写作时，其最新为5.10版本。
2.编译STREAM
我们使用C语言版本的stream.c（另有一个stream.f，是Fortune语言版本），然后运行下面的gcc命令编译。这里解释一下几个编译选项。
