内存架构往往是硬件架构中最复杂的部分. 

# 1 地址空间

很多把内存(这里特指安插在主板上的RAM)比作一个大数组, 地址就是这个数组的索引. 类似的, 地址空间则是更大的数组, 它是所有可用资源的集合, 同样, 地址是这个数组的索引. 地址空间可以划分成如下两种类型.

## 1.1 物理地址空间

硬件平台可粗略分为三部分: CPU, 内存和其它硬件设备. 其中, CPU是平台主导者, 从**CPU的角度**来看, **内存**和**其它硬件设备**都是可以使用的**资源**. 这些**资源组合(！！！**)在一起, 分布在**CPU的物理地址空间内(！！！内存只是一部分！！！**). CPU使用**物理地址索引这些资源(！！！**). **物理地址空间的大小**, 由CPU实现的**物理地址位数**决定, **物理地址位数**和**CPU处理数据的能力(即CPU位数**)没有必然关系, 例如**16位的8086 CPU**具有**20位地址空间**.

内存和其它硬件设备分布在物理地址空间中. 假设一个平台, CPU的**物理地址空间为4GB**, 有**512MB内存**, **其它硬件设备的I/O寄存器**被映射到**512MB的I/O地址**内, 则该平台的物理地址空间可能是如图所示划分的.

![config](./images/1.png)

如图, 512MB内存和I/O地址只占用物理地址空间的一部分, 还有大部分处于空闲. 数组再次显示了它的作用, 有一个4GB大小的数组, 其中1GB的元素具有有效值(512MB内存, 512MB I/O地址), 其它元素不存在.

## 1.2 线性地址空间

**一个平台只有一个物理地址空间**, 但**每个程序**都认为自己**独占整个平台的硬件资源**, 为让多个程序能够有效地相互隔离和使用物理地址空间的资源, 线性地址空间概念被引入. 和物理地址空间一样, 线性地址空间大小取决于CPU实现的线性地址位数, 例如实现了32位线性地址的CPU具有4GB大小的线性地址空间. 需要注意, 线性地址空间大小和物理地址空间大小没有必然关系. 例如Intel的PAE平台就具有4GB的线性地址空间, 64GB的物理地址空间.

线性地址空间会被映射到物理地址空间某一部分或整个物理地址空间. CPU负责将线性地址转换成物理地址, 使程序能正确访问到该线性地址空间所映射的物理地址空间. **一个平台**可以有**多个线性地址空间**, 在现代操作系统中, 每个进程都拥有自己的私有线性地址空间. 一个典型的线性地址空间如图.

![config](./images/2.png)

# 2 地址

地址是访问地址空间的索引. 根据访问地址的不同, 索引可以分为线性地址和物理地址. 但由于x86特殊的段机制, 还有一个额外的地址, 逻辑地址.

## 2.1 逻辑地址

该地址即程序直接使用的地址(x86架构无法禁用段机制, 逻辑地址一直存在). 例如

```c
int a = 1;
int *p = &a;
```

这里, 指针变量p存储的就是一个逻辑地址. **逻辑地址**由一个**16位的段选择符**和一个**32位的偏移量(32位平台**)构成. 逻辑地址的转换过程在后面介绍. 在上面例子中, 指针变量p实际上存储逻辑地址的偏移部分, 该偏移对应的段选择符位于段寄存器中, 并没有在程序中反映出来.

## 2.2 线性地址

又称虚拟地址. **线性地址**是**逻辑地址转换后的结果**, 用于**索引线性地址空间**. 当CPU使用分页机制时, 线性地址必须转换成物理地址才能访问平台内存或硬件设备; 当分页机制未启用时, 线性地址等于物理地址.

## 2.3 物理地址

该地址索引物理地址空间, 是CPU提交到总线用于访问平台内存和硬件设备的最终地址. 它和上面两个地址有如下关系.

(1) 分段机制启用, 分页未启用: 逻辑地址->线性地址=物理地址

(2) 分段 分页机制同时启用: 逻辑地址->线性地址->物理地址

有些资料还有"总线地址"的提法, 因为**给设备寄存器分配的物理地址(！！！**)和**寄存器在设备上的地址(！！！**)是不同的(通常**设备的寄存器**都**认为自己是从地址0开始**的), 两者存在一个**映射关系**, 由设**备的电子线路负责转换并对CPU透明(！！！**). 由于**CPU用于访问设备的物理地址**是设备寄存器展现给总线的地址, 所以在x86下有时称物理地址为总线地址.


