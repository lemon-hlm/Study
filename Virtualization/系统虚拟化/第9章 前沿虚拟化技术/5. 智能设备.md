
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

* [0 概述](#0-概述)
* [1 多队列网卡](#1-多队列网卡)
* [2 SR\-IOV](#2-sr-iov)

<!-- /code_chunk_output -->

# 0 概述

I/O设备的性能是影响虚拟化方案性能的一个重要因素, 尤其是网络设备和存储设备. 由于数据中心中的存储设备往往也是通过网络共享, 如SAN和iSCSI等, 因此I/O设备的性能问题也就主要是网络设备的性能问题, 智能设备也主要指网络智能设备.

**传统的基于软件的设备共享方案**由**虚拟机监控器**为**上层虚拟机**提供**虚拟的I/O设备**, 如**基于设备模型的完全虚拟化仿真设备**和**采用前后端分离设备模型的类虚拟化**. 基于软件的设备模型都是通过虚拟机监控器对客户机I/O操作的介入来实现将物理资源在多台客户机间实现共享, 如对仿真设备I/O读写的捕捉和仿真, 以及对分离式设备中I/O读写的递推等. 由于存在虚拟机监控器的介入, 基于软件的设备共享必定会对系统的整体性能产生负面的影响, 例如Xen虚拟化平台上基于仿真的Intel E1000网卡的传输带宽性能大概只有真是硬件能力的十几分之一; 类虚拟化下的虚拟网络设备的性能通常较仿真设备要好, 但对**万兆网卡也只能最多达1/3**, 并且这是牺牲大量CPU资源情况下取得的.

随着万兆网设备的普及以及数据中心对高速网络的需求, 基于软件的设备共享方法面临难以满足用户对设备性能需求的问题. 基于**IOMMU技术**的**完全硬件设备共享方案**, 如Intel VT\-d技术, 通过直接在**物理硬件层面**进行**设备虚拟**, 并将虚拟产生的PCI设备直接赋给客户机从而获得高性能的方法得到业界重视, 但是一台计算机中**可插入的PCI设备数目有限**, 而支持的虚拟机数目可能动态增加. 这也造成基于完全硬件的设备共享方案面临系统的**可扩展性问题**, 而且使用的物理硬件设备数量也直接关系到数据中心的建设和运转成本.

**智能设备**就是这样一种介于**基于软件的设备共享**和**基于完全硬件的设备共享**方案之间的**混合型解决方案**, 其具体形式可以有多种多样, 但他们都具有利用**在硬件功能减少虚拟机监控器介入**的同时, 又**不完全摒弃虚拟机监控器辅助**的共同特点. 

智能设备可以是**基于公开的工业规范实现**, 也可以是一家**公司独享的私有方案**. 其中, 比较有代表性的实现有使用**多队列(Multi Queue)的网卡**、**PCI SIG**的Single Root IO Virtualization(**SR\-IOV**)和SolarFlare公司的10G网卡等.

# 1 多队列网卡

**多队列技术**已经在今天的原生操作系统得到广泛应用, 如Linux操作系统在2.6.24版本的内核中就引入了该项技术. 它利用**硬件！！！提供的多个网络包发送队列和接受队列特性**, 将**重要进程的网络操作！！！** 直接**绑定到一个或多个网络包处理队列！！！**上, 从而由硬件保证网络带宽.

如图9\

# 2 SR\-IOV

