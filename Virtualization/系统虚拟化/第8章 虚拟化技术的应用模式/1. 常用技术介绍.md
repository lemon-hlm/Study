
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

* [1 虚拟机的动态迁移](#1-虚拟机的动态迁移)
	* [1.1 什么是虚拟机的动态迁移](#11-什么是虚拟机的动态迁移)
	* [1.2 虚拟机动态迁移的特点](#12-虚拟机动态迁移的特点)
* [2 虚拟机快照](#2-虚拟机快照)
	* [2.1 什么是虚拟机快照](#21-什么是虚拟机快照)
	* [2.2 为什么要使用虚拟机快照](#22-为什么要使用虚拟机快照)
* [3 虚拟机克隆](#3-虚拟机克隆)
	* [3.1 什么是虚拟机克隆](#31-什么是虚拟机克隆)
	* [3.2 为什么需要虚拟机克隆](#32-为什么需要虚拟机克隆)
* [4 案例分析: VMware VMotion和VMware快照](#4-案例分析-vmware-vmotion和vmware快照)
	* [4.1 VMware VMotion](#41-vmware-vmotion)

<!-- /code_chunk_output -->

# 1 虚拟机的动态迁移

## 1.1 什么是虚拟机的动态迁移

**迁移**, 分为**系统的迁移**和**工作的迁移**. 

- **系统迁移**是指把**整个系统的软件**, 包括**操作系统**, 完全复制到另一个机器上;

- **工作迁移**是指把某台机器上的**一些工作转移到别的机器**上

先看看**传统的无虚拟机**和**有虚拟机的静态迁移**是什么样子的. 

**无虚拟机**下的**系统迁移**是指在没有虚拟机的环境下把一台机器的所有软件, 包括所有状态都复制到另一台机器上. 这种迁移可以通过先做出**系统镜像**, 然后**复制**到其他机器上, 或通过硬盘互相复制的方式来实现迁移.

**无虚拟机**的**工作迁移**则需要**特殊的系统支持**, 如哥伦比亚大学的Zap系统, 通过在操作系统上实现一层薄的虚拟层, 实现工作的**实时迁移**. 

虚拟机的静态迁移指在关闭虚拟机的情况下, 使用文件传输软件将虚拟机的镜像传输到另外的机器上, 然后启动虚拟机. 此种情况下, 不能实现工作的迁移.

最后看看有虚拟机的动态迁移, 所谓虚拟机的**动态迁移**, 是指在**虚拟机运行**的情况下, **实时将虚拟机1迁移到另一个虚拟机2**. 具体讲, 就是将**物理服务器A**上的**内存**里的**所有关于虚拟机1的信息**全部**封包通过网络移交到物理服务器B**上, 从而**形成新的虚拟机2**. 这是一个内存信息的移交与转换的过程, 速度快, 其唯一限制就是网络带宽与突然停电之类的突发情况. 这种模式下, 如果**VMM只把某些工作的信息**传送给**其它虚拟机**中, 则可以实现**工作的实时迁移**.

## 1.2 虚拟机动态迁移的特点

虚拟机的动态迁移具有如下优点

⓵ 在**非停机情况**下进行**迁移**, 可实现**在线的系统维护**, 提高系统的**可维护性**, 优化系统中的**资源分配**, 以及通过将**不正常工作的宿主机**的工作迁移到**正常工作的宿主机**中实现**高可用性**

⓶ 前面提到, 虚拟化去掉了硬件的相关性, 从而实现不同硬件上的虚拟机之间的动态迁移, 极大扩大了可迁移的面, 使虚拟机的动态迁移在实用性方面较之以前的方法有很大进步.

⓷ 虚拟机通常将硬件资源抽象成一个或一些文件, 极大简化了虚拟机之间迁移的配置过程, 更进一步, 虚拟机之间的迁移还可以通过配置管理工具自行进行管理, 提高了系统的可维护性.

⓸ 通过迁移管理工具, 可详细记录迁移, 保持追踪, 从而在出问题时候有依据.

还可以指定某一时刻进行迁移工作.

# 2 虚拟机快照

## 2.1 什么是虚拟机快照

就是将**某一个时刻**虚拟机的**状态**像照片一样保存下来. 通常, 快照将要保存所有的**硬盘信息**、**内存信息！！！**和**CPU信息**, VMware还将保存BIOS信息.

## 2.2 为什么要使用虚拟机快照

虚拟机快照用在很多地方, 包括测试、备份和安全等. 

测试, 想测试一个新软件, 并不知道软件将会对系统产生什么影响. 在测试之前做过快照, 有问题只需要回滚到快照之前.

备份, 可定期做虚拟机快照并将快照产生的文件保存在备份盘上面. 听起来类似于Ghost备份, 但使用虚拟机的快照有以下优点:

⓵ 备份可以由虚拟机管理工具实现, 可定时备份等.

⓶ 通常Ghost备份会复制所有文件, 所以生成的备份文件非常大, 而虚拟机有自身的文件格式, 可以生成**增量的文件备份**, 使备份文件显著减少

⓷ 因为虚拟机快照很好保存了当前虚拟机的运行状态, 这些运行的状态可为程序调试提供很好信息

# 3 虚拟机克隆

## 3.1 什么是虚拟机克隆

指将一个系统的状态完全不变的复制到另外一个系统上, 形成两个完全相同的系统, 这里的相同指的是操作系统及应用程序的相同. 

由于VMM中维护的信息可能是有所不同, 并且如果从物理机到虚拟机的克隆也可能会有设备上的改动, 两个系统的运行环境也就可能不同. 虚拟机的克隆主要分为两种: 虚拟机到虚拟机的克隆和物理机到虚拟机的克隆.

虚拟机到虚拟机的克隆, 分为静态克隆和动态克隆, 静态克隆即将虚拟机的状态用快照技术保存下来, 将保存下来的镜像复制到其它机器. 动态克隆即通过网络, 同步地将所有的状态迁移到其它的虚拟机上. 此种方法有点在于可同时对N台虚拟机进行克隆操作; 缺点在于此间如果断电, 被克隆的机器将进入不可预计状态.

物理机到虚拟机的克隆, 此种克隆只能使用静态克隆, 因为物理机不具备动态迁移能力. 当需要从一台物理机迁移到虚拟机时候, 虚拟机将会首先虚拟出和物理机相同的硬件(同样的CPU、内存和硬盘等), 然后通过迁移工具将物理机上的状态全部克隆到虚拟机上. 

这个功能很重要, 原因主要两点.

⓵ 此种克隆不用重装OS, 不用重装任何软件, 传统的系统可以非常方便移植到当前虚拟机上, 

⓶ 当需要在虚拟环境下测试物理机上已装好的软件时, 可将此系统克隆到虚拟机中进行测试.

## 3.2 为什么需要虚拟机克隆

利用虚拟机克隆技术, 只需要先安装并配置好一台虚拟机, 然后克隆到到其它数万台机器上, 从而大大降低时间.

# 4 案例分析: VMware VMotion和VMware快照

## 4.1 VMware VMotion

动态迁移中只需要着重处理以下三个类的状态.

- 虚拟设备的状态, 例如CPU、主板、网络、存储设备和显卡适配器等.
- 外部设备的状态, 例如网络、USB设备和SCSI存储设备等.
- 虚拟机内存. 

实际迁移中, 一共包括5个步骤

⓵ 初始化动态迁移, 即选择哪个虚拟机需要迁移, 其目标机器是哪个.

⓶ **虚拟机继续在源主机上运行**, 与此同时, 该**虚拟机的内存**被**提前**传输到**目标机器上缓存**起来. 该步骤可能执行多次, 在**第一次循环后**, 后面的几次循环**只需要将被改变的内存**传输过去, 以**减少时间的损耗**.

⓷ 停止虚拟机的运行, 把当前虚拟机的非内存状态, 例如CPU状态, 传送到目标机器.

⓸ 把虚拟机的控制权转移到目标机器并重新启动虚拟机运行.

⓹ 把在停止虚拟机运行时没有传输到目标机器的内存传输过去, 并在源端销毁虚拟机相关的信息, 释放资源.

虚拟机动态迁移过程中有几个地方需要特殊处理, 包括网络、磁盘设备还有物理内存.

1. 在虚拟机迁移中, 由于虚拟机从一个物理机迁移到另一台, 其网络设备面临一个挑战: 原来打开的网络连接在迁移后也是连接着的. VMware ESX Server使用虚拟网络架构技术(Virtual Network Architecture)解决这个问题.

在这个架构中, 每个虚拟机都有自己的虚拟网络网卡(Virtual Ethernet Network Interface Card, VNIC), 每个VNIC有自己

