从软件角度看, 物理机器是由处理器、内存和I/O设备等一组资源构成的实体. 虚拟机也一样, 由虚拟处理器、虚拟内存和虚拟I/O设备等组成。 

VMM基本上可以分为两部分: 虚拟环境的管理和物理资源的管理. 前一部分是所有VMM产品需要提供的基本功能, 后一部分根据实现结构的差异, 也各有差异.

# 1 虚拟环境的管理

## 1.1 虚拟资源

VMM需要提供如下基本模块.

⓵ 处理器虚拟化模块. 为虚拟机提供虚拟处理器.

⓶ 内存虚拟化模块. 为虚拟机提供虚拟内存

⓷ 设备虚拟化模块. 为虚拟机提供虚拟I/O设备.

## 1.2 虚拟环境的调度

操作系统调度的单位是进程/线程, VMM调度的调度单位是虚拟处理器. 当虚拟处理器被调度到时, VMM调度程序负责将虚拟处理器上下文装载到物理处理器上, 然后虚拟处理器所对应的客户机指令开始真正被执行. 当时间片用完或虚拟处理器主动让出, 调度程序被触发. 调度程序根据调度策略, 挑选下一个虚拟处理器继续运行.

VMM调度策略可以有多种, 例如平均分配时间片, 或按照虚拟机权重等.

## 1.3 虚拟机间通信机制

与OS中进程间通信类似, 虚拟环境下也存在虚拟机间通信机制. 虚拟机间通信机制为虚拟机互相通信的手段. 比如, 类虚拟化I/O中是基于事务的模型, 一个I/O事务需要特权虚拟机和正常虚拟机共同合作完成, 中间就会大量用到虚拟机间通信.

虚拟机间通信机制从实现上很多. 通常来讲, VMM实现虚拟机间的通信机制, 并向虚拟机提供相应的API. 虚拟机的客户OS通过调用这些API与其他虚拟机通信. 这些API可以是事件通知, 也可以是共享内存等. 

VMM还提供了虚拟机与VMM之间交互的API.

## 1.4 虚拟化环境的管理接口

虚拟机的管理功能由上层的管理程序和VMM提供的管理接口组成. VMM提供一组完备的管理接口, 来支持虚拟环境的创建、删除、暂停、查询和迁移等功能. 上层的管理程序则通过调用VMM提供的管理接口, 为用户提供管理界面

# 2 物理资源的管理

与OS一样, VMM本身承担全部或部分物理资源管理角色.

## 2.1 处理器管理

包括系统启动时检测并获取所有的处理器; 对每个处理器进行初始化, 如设置运行模式、设置页表、设置中断处理函数等; 将所有处理器纳入调度序列, 由调度程序对处理器进行调度. 有些VMM还支持对物理处理器的热插拔. 有些VMM还具有高可靠性的支持, 当收到处理器失效通知时, 如MCA(Machine Check Abort), VMM将其做热拔出处理.

## 2.2 内存管理

包括系统启动时VMM检测并获取内存; 对获得的内存的初始化, 包括分页并设置页表等; 提供内存分配接口, 以便VMM的其它模块能获得/释放内存; 给虚拟机分配内存, 并维护虚拟机物理地址与实际物理地址的映射关系, 以供VMM其它模块查询使用.

## 2.3 中断管理

VMM负责初始化并设置中断相关资源, 如处理器中断向量表、Local APIC和中断控制器(I/O APIC、8259 PIC). 当中断发生后, VMM是接收者, 它会根据中断的来源, 或直接处理, 或转发到相应特权虚拟机来处理.

## 2.4 系统时间维护

VMM拥有和时间相关的硬件资源, 因此VMM负责维护系统时间, 并向各虚拟机提供虚拟化的时间.

## 2.5 设备管理

Hypervisor模型中, 所有外设都属于VMM, 因此, VMM需要包含所有设备的驱动程序来管理这些设备. 混合模型下, 大部分外设属于特权客户操作系统, 由特权客户OS的驱动程序来管理这些外设. VMM也拥有少部分的设备, 如用于调试的串口, 因此也需要包含这些设备的驱动程序.

# 3 其它模块

VMM通常还包括以下功能模块

## 3.1 软件定时器

通常是通过时钟中断处理函数来实现的, 在VMM中广泛使用, 如系统时间的维护等.

## 3.2 多处理器同步原语(spinlock、rcu等)

与OS一样, 当多处理器共享同一个资源时, VMM需要提供同步原语来同步多处理器的读写访问.

## 3.3 调试手段(包括系统级别和虚拟环境待定)

printk是最简单的调试手段, 有些还会开发其他调试工具

## 3.4 性能采集与分析工具

VMM通常也会提供profiling工具, 用于性能数据的采集和分析. 这些能采集VMM的全局的性能数据, 也能采集针对某个虚拟机的性能数据.

## 3.5 安全机制

VMM要保证各个虚拟机之间, 以及虚拟机与VMM之间是隔离的.

## 3.6 电源管理

包括处理器电源管理、睡眠状态电源管理等.



