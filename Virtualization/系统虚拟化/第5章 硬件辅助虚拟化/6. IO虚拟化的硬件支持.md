# 1 概述

**软件虚拟化**章节使用**软件**方式实现**I/O虚拟化**, 目前流行的"**设备模拟**"和"**类虚拟化**"都有各自的优点, 以及与生俱来的缺点. **前者通用性强**, 但**性能不理想**; 后者**性能不错**, 却**不通用**. Intel的**VT\-d**技术(Intel(R) Virtualization Technology for Directed I/O), 以帮助实现**通用性强**、**性能高**的**新型I/O虚拟化技术**.

介绍VT\-d之前, 先量化评价**I/O虚拟化的两个指标** \-\- **性能**和**通用性**. 性能, 越接近**无虚拟环境的I/O性**能越好; 通用性主要和**完全虚拟化**挂钩, 使用的**I/O虚拟化**技术对**客户机OS越透明**(客户机OS感知不到I/O虚拟化技术), 通用性越强. 

VT\-d如何实现这两个指标呢? 

- 对于**高性能**, 最直接方法就是让**客户机直接使用真实的硬件设备**, 这样**客户机的I/O路径**几乎和**无虚拟化的I/O路径相同**; 
- 对于**通用性**, 就得用**全虚拟化方法**, 让**客户机OS**能使用**自带驱动发现设备！！！、操作设备！！！**。

实现这些目标面临的挑战.

**客户机直接操作设备**的挑战:

⓵ 如何让客户机直接访问**设备真实的I/O地址空间**(包括**MMIO**和**端口IO**)

⓶ 如何让**设备的DMA操作直接访问到客户机的内存空间**? 设备不关心系统中运行的是虚拟机还是真实OS, 它只用**驱动**给提供的**物理地址做DMA**.

**通用性**面临的问题和⓵类似, 要有一种方法将**设备的I/O地址空间**告诉给**客户机OS**, 并让**驱动**能够利用**这些地址**访问到**真实的I/O地址空间**.

**VT\-x！！！**已经能够解决**第一个问题**, 可以允许**客户机直接访问物理的I/O空间！！！**. 

**VT\-d**让**第二个问题**解决成为可能, 它提供了**DMA重映射技术！！！**, 帮助VMM的实现者达成目标.

VT\-d通过在**北桥(MCH**)引入**DMA重映射硬件**, 以提供**设备重映射**和**设备直接分配**的功能. 在启用VT\-d的平台上, **设备的所有DMA传输！！！**都会被**DMA重映射硬件截获！！！**. 根据**设备对应的I/O页表！！！**, **硬件**可以对**DMA中的地址进行转换！！！**, 使设备**只能访问到规定的内存！！！**. 

使用VT\-d后, 设备访问内存的架构如图5\-16所示.

![config](./images/25.png)

图5\-16(a)是**没有VT\-d**的平台, 此时**设备的DMA**能够访问**整个物理内存**. (b)是**启用VT\-d**的情况, 此时, 设备**只能访问指定的物理内存**. 这和使用页表将进程的线性地址空间映射到指定物理内存区域的思想一样, 不过对象换成了设备. 

下面介绍VT\-d中核心的**DMA重映射技术**以及**如何探测DMA重映射硬件**, **设备分配**内容在6.7介绍. VT\-d技术较复杂, 限于篇幅, 只能对主要技术进行介绍, 完整的论述参考"**Intel(R) Virtualization Technology for Directed I/O Architecture Specification**".

# 2 VT\-d技术

上节提到的诸多难点, 最主要的难题是DMA问题. 设备对系统中运行的软件一无所知, 在进行DMA时, 设备唯一做的是向(从)驱动程序告知的"物理地址"复制(读取)数据. 内存虚拟化中可知, 虚拟机环境下客户机使用的是GPA, 则客户机的驱动