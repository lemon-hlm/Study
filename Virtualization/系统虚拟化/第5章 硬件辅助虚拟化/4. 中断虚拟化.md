# 1 概述

物理平台, 外部中断流程如图5\-9. 首先, I/O设备通过中断控制器(I/O APIC或PIC)发出中断请求, 中断请求经由PCI总线发送到系统总线上, 最后目标CPU的Local APIC部件接收中断, CPU开始处理中断.

虚拟化环境中, VMM也需要为客户机OS展现一个与物理中断架构类似的虚拟中断架构. 图5\-10展现虚拟机中断架构. 和物理平台一样, 每个VCPU都对应一个虚拟Local APIC用于接收中断. 虚拟平台也包含虚拟I/O APIC或虚拟PIC用于发送中断. 和VCPU一样, 虚拟Local APIC、虚拟I/O APIC和虚拟PIC都是VMM维护的软件实体。当虚拟设备需要发送中断时, 虚拟设备会调用虚拟I/O APIC的接口发送中断. 虚拟I/O APIC根据中断请求, 挑选出相应的虚拟Local APIC, 调用其接口发送中断请求. 虚拟Local APIC进一步利用VT\-x的事件注入机制将中断注入到相应的VCPU.

可见, 中断虚拟化的主要任务是实现图5\-10描述的虚拟中断架构, 具体包括虚拟PIC、虚拟I/O APIC和虚拟Local APIC, 并实现中断的生成、采集和注入的整个过程.

