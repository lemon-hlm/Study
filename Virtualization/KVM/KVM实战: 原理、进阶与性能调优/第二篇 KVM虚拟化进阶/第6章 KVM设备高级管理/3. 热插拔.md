
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

* [0 概述](#0-概述)
* [1 PCI设备热插拔](#1-pci设备热插拔)
* [2 PCI设备热插拔示例](#2-pci设备热插拔示例)
	* [2.1 网卡的热插拔](#21-网卡的热插拔)
	* [2.2 USB设备的热插拔](#22-usb设备的热插拔)
	* [2.3 SATA硬盘控制器的热插拔](#23-sata硬盘控制器的热插拔)

<!-- /code_chunk_output -->

# 0 概述

热插拔（hot plugging）即“带电插拔”，指可以在计算机运行时（不关闭电源）插上或拔除硬件。热插拔最早出现在服务器领域，目的是提高服务器扩展性、灵活性和对灾难的及时恢复能力。

实现热插拔需要有几方面支持：**总线电气特性**、**主板BIOS**、**操作系统**和**设备驱动**。

目前，在服务器硬件中，可实现热插拔的部件主要有SATA硬盘（IDE不支持热插拔）、CPU、内存、风扇、USB、网卡等。

在KVM虚拟化环境中，在**不关闭客户机**的情况下，也可以对客户机的设备进行热插拔。目前，主要支持**PCI设备**、**CPU**￼、**内存**的**热插拔**。
￼
注: CPU目前不支持热拔出

# 1 PCI设备热插拔

在6.2节中介绍的VT-d设备直接分配和SR-IOV技术时都是在客户机启动时就分配相应的设备，本节将介绍可以通过热插拔来添加或删除这些PCI设备。QEMU/KVM支持动态添加和移除各种PCI设备，包括QEMU模拟的virtio类别的以及VT-d直接分配的。

PCI设备的热插拔主要需要如下几个方面的支持。

（1）BIOS

QEMU/KVM默认使用SeaBIOS￼作为客户机的BIOS，该BIOS文件路径一般为/usr/local/share/qemu/bios.bin。目前默认的BIOS已经可以支持PCI设备的热插拔。

（2）PCI总线

（对于VT-d传入的设备）物理硬件中必须有VT-d的支持，而且现在的PCI、PCIe总线都支持设备的热插拔。

（3）客户机操作系统

多数流行的Linux和Windows操作系统都支持设备的热插拔。可以在客户机的Linux系统的内核配置文件中看到一些相关的配置。以下是RHEL 7系统中的部分相关配置：

```
CONFIG_HOTPLUG_PCI_PCIE=y￼ CONFIG_HOTPLUG_PCI=y￼ CONFIG_HOTPLUG_PCI_ACPI=y￼ CONFIG_HOTPLUG_PCI_ACPI_IBM=m￼ CONFIG_HOTPLUG_PCI_SHPC=m
```

（4）客户机中的驱动程序

一些网卡驱动（如Intel的e1000e、igb、ixgbe、igbvf、ixgbevf等）、SATA或SAS磁盘驱动、USB2.0、USB3.0驱动都支持设备的热插拔。注意，在一些较旧的Linux系统（如RHEL 5.5）中需要加载“acpiphp”（使用“modprobe acpiphp”命令）这个模块后才支持设备的热插拔，否则热插拔完全不会对客户机系统生效；而较新内核的Linux系统（如RHEL 6以后、Fedora 17以后等）中已经没有该模块，不需要加载该模块，默认启动的系统就支持设备热插拔。

有了BIOS、PCI总线、客户机操作系统和驱动程序的支持后，热插拔功能只需要在QEMU monitor中使用两个命令即可完成。将一个BDF为02：00.0的PCI设备动态添加到客户机中（设置id为mydevice），在monitor中的命令如下：

```
device_add vfio-pci,host=02:00.0,id=mydevice
```

将一个设备（id为mydevice）从客户机中动态移除，在monitor中的命令如下：

```
device_del mydevice
```

这里的mydevice是在添加设备时设置的唯一标识，可以通过“info pci”命令在QEMU monitor中查看到当前的客户机中的PCI设备及其id值。在6.2.2节中也已经提及，在命令行启动客户机时分配设备也可以设置这个id值，如果这样，那么也就可以用“device_del id”命令将该PCI设备动态移除。

# 2 PCI设备热插拔示例

在介绍了PCI设备热插拔所需的必要条件和操作命令之后，本节分别以网卡、U盘、SATA硬盘的热插拔为例来演示具体的操作过程。

## 2.1 网卡的热插拔

1）启动一个客户机，不向它分配任何网络设备。命令行如下：

```
[root@kvm-host ~]# qemu-system-x86_64 -enable-kvm -smp 4 -m 8G rhel7.img -net none
```

2）选择并用vfio-pci隐藏一个网卡设备供热插拔使用。命令行如下：

```
[root@kvm-host ~]# lspci -s 05:00.0￼ 05:00.0 Ethernet controller: Intel Corporation 82599ES 10-Gigabit SFI/SFP+ Network Connection (rev 01)￼ [root@kvm-host ~]# ./vfio-pci.sh -h 05:00.0￼ 0￼ Unbinding 0000:05:00.0 from ixgbe￼ Binding 0000:05:00.0 to vfio-pci
```

这里选取了Intel 82599网卡的一个口作为热插拔的设备。
3）切换到QEMU monitor中，将网卡动态添加到客户机中，命令如下所示。一般可以用“Ctrl+Alt+2”组合键进入monitor中，也可以在启动时添加参数“-monitor stdio”，将monitor定向到当前终端的标准输入输出中直接进行操作。

```
(qemu) device_add vfio-pci,host=05:00.0,id=nic0
```

4）在QEMU monitor中查看客户机的PCI设备信息。命令如下：

```
(qemu) info pci￼ ......￼ Bus  0, device   3, function 0:￼     Ethernet controller: PCI device 8086:10fb￼         IRQ 10.￼         BAR0: 64 bit prefetchable memory at 0xc0000000 [0xc007ffff].￼         BAR2: I/O at 0xffffffffffffffff [0x001e].￼         BAR4: 64 bit prefetchable memory at 0xc0080000 [0xc0083fff].￼         id "nic0"
```

由以上信息可知，“Bus 0，device 3，function 0”设备就是动态添加的网卡设备。

5）在客户机中检查动态添加和网卡工作情况。命令行如下：

```
[root@kvm-guest ~]# lspci | grep -i eth￼ 00:03.0 Ethernet controller: Intel Corporation 82599ES 10-Gigabit SFI/SFP+ Network Connection (rev 01)￼ [root@kvm-guest ~]# ifconfig￼ ens3: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500￼     inet 192.168.100.194  netmask 255.255.252.0  broadcast 192.168.103.255￼     inet6 fe80::92e2:baff:fec4:7394  prefixlen 64  scopeid 0x20<link>￼     ether 90:e2:ba:c4:73:94  txqueuelen 1000  (Ethernet)￼     RX packets 297  bytes 27154 (26.5 KiB)￼     RX errors 0  dropped 0  overruns 0  frame 0￼     TX packets 104  bytes 14644 (14.3 KiB)￼     TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0 ￼ ......￼ [root@kvm-guest ~]# route -n￼ Kernel IP routing table￼ Destination     Gateway         Genmask         Flags Metric Ref    Use Iface￼ 0.0.0.0         192.168.100.1   0.0.0.0         UG    100    0        0 ens3￼ 192.168.100.0   0.0.0.0         255.255.252.0   U     100    0        0 ens3￼ 192.168.122.0   0.0.0.0         255.255.255.0   U     0      0        0 virbr0￼ [root@kvm-guest ~]# ping 192.168.100.1￼ PING 192.168.100.1 (192.168.100.1) 56(84) bytes of data.￼ 64 bytes from 192.168.100.1: icmp_seq=1 ttl=255 time=0.474 ms￼ 64 bytes from 192.168.100.1: icmp_seq=2 ttl=255 time=0.556 ms￼ ^C￼ --- 192.168.100.1 ping statistics ---￼ 2 packets transmitted, 2 received, 0% packet loss, time 1000ms￼ rtt min/avg/max/mdev = 0.474/0.515/0.556/0.041 ms
```

由以上输出信息可知，动态添加的网卡是客户机中唯一的网卡设备，其网络接口名称为“ens3”，它的网络连接是通畅的。

6）将刚添加的网卡动态地从客户机中移除。命令行如下：

```
(qemu) device_del nic0
```

将网卡动态移除后，在monitor中用“info pci”命令查不到刚才的PCI网卡设备信息，在客户机中用“lspci”命令也不能看到客户机中有网卡设备的信息。

## 2.2 USB设备的热插拔

USB设备是现代计算机系统中比较重要的一类设备，包括USB的键盘和鼠标、U盘，还有现在网上银行经常可能用到的USB认证设备（如工商银行的“U盾”）。如本节前面讲到的那样，USB设备也可以像普通PCI设备那样进行VT-d设备直接分配，而在热插拔方面也是类似的。下面以USB鼠标的热插拔为例来介绍一下操作过程。

USB设备的热插拔操步骤和前面介绍网卡热插拔的步骤基本是一致的，需要注意以下几点：

- 对于USB设备，使用两个专门的命令（usb_add和usb_del）对单个USB设备进行热插拔操作。当然，还可以用“device_add”和“device_del”将USB根控制器（它是一个PCI设备）连带它上面的所有USB设备一并热插拔。
- QEMU默认没有向客户机提供USB总线，需要在启动客户机的qemu命令行中添加“-usb”参数（或“-device piix4-usb-uhci”参数），来提供客户机中的USB总线。
- QEMU的usb_add/del热插拔，包括启动时（-usbdevice host）指定，都依赖于libusb包，需要在宿主机上安装好libusbx-devel￼包，再编译QEMU（--enable-libusb）。可以在编译完QEMU之后，通过查看config-host.mak里面有没有“CONFIG_USB_LIBUSB=y”来确认USB功能有没有被编译进去。
- machine type（qemu-machine或者-M参数）最好指定成较新的q35。QEMU默认模拟的machine type是“pc”Standard PC(i440FX+PIIX，1996)，它比较老了，在加上-usb参数后，QEMU模拟的USB系统总线常常不能与USB2.0以后的设备很好地兼容。

1）查看宿主机中的USB设备情况，然后启动一个带有USB总线控制器的客户机。命令行如下：

```
[root@kvm-host ~]# lsusb￼ Bus 002 Device 002: ID 8087:8002 Intel Corp. ￼ Bus 002 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub￼ Bus 001 Device 002: ID 8087:800a Intel Corp. ￼ Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub￼ Bus 004 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub￼ Bus 003 Device 004: ID 046b:ff10 American Megatrends, Inc. Virtual Keyboard and Mouse￼ Bus 003 Device 003: ID 03f0:8607 Hewlett-Packard Optical Mobile Mouse￼ Bus 003 Device 002: ID 14dd:1005 Raritan Computer, Inc. ￼ Bus 003 Device 005: ID 03f0:0024 Hewlett-Packard KU-0316 Keyboard￼ Bus 003 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub ￼ [root@kvm-host ~]# qemu-system-x86_64 -enable-kvm -smp 4 -m 8G rhel7.img -M q35 -usb -net none
```

2）切换到QEMU monitor窗口，动态添加USB鼠标给客户机。使用“usb_add”命令行如下：

```
(qemu) usb_add host:003.003
```

或者，

```
(qemu) usb_add host:03f0:8607
```

而像6.2.4节中那样将宿主机中USB根控制器作为PCI设备分配给客户机，对其进行隐藏，然后使用device_add命令动态添加设备。命令如下：

```
(qemu) device_add vfio-pci,host=00:14.0,id=myusb
```

解释一下“usb_add”这个用于动态添加一个USB设备的命令，在monitor中命令格式如下：

```
usb_add devname
```

其中devname是对该USB设备的唯一标识，该命令支持两种devname的格式：一种是USB hub中的Bus和Device号码的组合，一种是USB的vendor ID和device ID的组合（在6.2.3节中也曾提及过）。举个例子，对于该宿主机中的一个SanDisk的U盘设备（前一步的lsusb命令），devname可以设置为“003.003”和“03f0：8607”两种格式。另外，需要像上面命令行操作的那样，用“host：003.003”或“host：03f0：8607”来指定分配宿主机中的USB设备给客户机。

3）在客户机中，查看动态添加的USB设备。命令行如下：

```
[root@kvm-guest ~]# lsusb￼ Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub￼ Bus 004 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub￼ Bus 003 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub￼ Bus 002 Device 002: ID 03f0:8607 Hewlett-Packard Optical Mobile Mouse￼ Bus 002 Device 001: ID 1d6b:0001 Linux Foundation 1.1 root hub
```

可见，USB鼠标已经成功地被客户机识别了。

4）在QEMU monitor中查看USB设备，然后动态移除USB设备。命令行操作如下：

```
(qemu) info usb￼     Device 0.2, Port 3, Speed 1.5 Mb/s, Product HP Mobile USB Optical Mouse ￼ (qemu) usb_del 0.2￼ (qemu) info usb
```

由上面的输出信息可知，移除前，用“info usb”命令可以看到USB设备，在用“usb_del”命令移除后，用“info usb”命令就没有查看到任何USB设备了。注意，usb_del命令后的参数是用“info usb”命令查询出来的“Device”后的地址标识，这里为“0.2”。笔者发现在自己环境中（RHEL 7+QEMU 2.7+libusbx），usb_del操作尽管可以成功，但会出现“libusb_release_interface：-4[NO_DEVICE]”的错误。

当然，对于使用device_add命令动态添加的USB设备，则应使用如下device_del命令将其移除：

```
(qemu) device_del myusb
```

## 2.3 SATA硬盘控制器的热插拔
与6.2.4节类似，在本节的示例中，宿主机从一台机器上的SAS硬盘启动，然后将SATA硬盘动态添加给客户机使用，接着动态移除该硬盘。
1）检查宿主机系统，得到需要动态热插拔的SATA硬盘（实际上用的是整个SATA控制器），并将其用vfio-pci模块隐藏起来以供热插拔使用。命令行操作如下：

[root@kvm-host ~]# lspci | grep SATA￼ 00:1f.2 SATA controller: Intel Corporation 82801JI (ICH10 Family) SATA AHCI Controller￼ [root@kvm-host ~]# lspci | grep SAS￼ 16:00.0 SCSI storage controller: LSI Logic / Symbios Logic SAS1078 PCI-Express Fusion-MPT SAS (rev 04)￼ [root@kvm-host ~]# df -h￼ Filesystem            Size  Used Avail Use% Mounted on￼ /dev/sda1             197G   76G  112G  41% /￼ tmpfs                  12G   76K   12G   1% /dev/shm￼ [root@kvm-host ~]# ls -l /dev/disk/by-path/pci-0000\:16\:00.0-sas-0x1221000000000000-lun-0￼ lrwxrwxrwx 1 root root 9 Oct 29 15:28 /dev/disk/by-path/pci-0000:16:00.0-sas-0x1221000000000000-lun-0 -> ../../sda￼ [root@kvm-host ~]# ls -l /dev/disk/by-path/pci-0000\:00\:1f.2-scsi-0\:0\:0\:0￼ lrwxrwxrwx 1 root root 9 Oct 29 15:28 /dev/disk/by-path/pci-0000:00:1f.2-scsi-0:0:0:0 -> ../../sdb￼ [root@kvm-host ~]# lspci -k -s 00:1f.2￼ 00:1f.2 SATA controller: Intel Corporation 82801JI (ICH10 Family) SATA AHCI Controller￼     Subsystem: Intel Corporation Device 34f8￼     Kernel driver in use: ahci￼     Kernel modules: ahci￼ [root@kvm-host ~]# ./vfio-pci.sh -h 00:1f.2￼ Unbinding 0000:00:1f.2 from ahci￼ Binding 0000:00:1f.2 to vfio-pci￼ [root@kvm-host ~]# lspci -k -s 00:1f.2￼ 00:1f.2 SATA controller: Intel Corporation 82801JI (ICH10 Family) SATA AHCI Controller￼     Subsystem: Intel Corporation Device 34f8￼     Kernel driver in use: vfio-pci￼     Kernel modules: ahci

2）启动一个客户机。命令行如下：

[root@kvm-host ~]# qemu-system-x86_64 rhel7.img -m 1024 -smp 2￼ VNC server running on ‘::1:5900'

3）在QEMU monitor中，动态添加该SATA硬盘。命令行如下：

(qemu) device_add vfio-pci,host=00:1f.2,id=sata,addr=0x06￼ (qemu) info pci   #查看客户机中pci设备，可以看到动态添加的SATA控制器￼     Bus  0, device   6, function 0:￼         SATA controller: PCI device 8086:3a22￼             IRQ 9.￼             BAR0: I/O at 0x1020 [0x1027].￼             BAR1: I/O at 0x1030 [0x1033].￼             BAR2: I/O at 0x1028 [0x102f].￼             BAR3: I/O at 0x1034 [0x1037].￼             BAR4: I/O at 0x1000 [0x101f].￼             BAR5: 32 bit memory at 0x40000000 [0x400007ff].￼             id "sata"

4）在客户机中查看动态添加的SATA硬盘。命令行如下：

[root@kvm-guest ~]# fdisk -l /dev/sdb￼ ￼ Disk /dev/sdb: 164.7 GB, 164696555520 bytes￼ 255 heads, 63 sectors/track, 20023 cylinders￼ Units = cylinders of 16065 * 512 = 8225280 bytes￼ Sector size (logical/physical): 512 bytes / 512 bytes￼ I/O size (minimum/optimal): 512 bytes / 512 bytes￼ Disk identifier: 0x0003e001￼ ￼     Device Boot     Start         End      Blocks   Id  System￼ /dev/sdb1   *           1        6528    52428800   83  Linux￼ /dev/sdb2            6528        7050     4194304   82  Linux swap / Solaris￼ /dev/sdb3            7050        9600    20480000   83  Linux￼ ￼ [root@kvm-guest ~]# lspci -k -s 00:06.0￼ 00:06.0 SATA controller: Intel Corporation 82801JI (ICH10 Family) SATA AHCI Controller￼     Subsystem: Intel Corporation Device 34f8￼     Kernel driver in use: ahci￼     Kernel modules: ahci

由以上信息可知，客户已经能够获取到SATA硬盘（/dev/sdb）的信息，然后就可以正常使用动态添加的硬盘了。
5）在客户机中使用完SATA硬盘后，可以动态移除SATA硬盘。在QEMU monitor中命令行如下：

