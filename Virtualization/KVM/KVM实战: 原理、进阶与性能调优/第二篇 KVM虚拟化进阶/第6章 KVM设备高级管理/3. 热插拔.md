
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

* [0 概述](#0-概述)
* [1 PCI设备热插拔](#1-pci设备热插拔)

<!-- /code_chunk_output -->

# 0 概述

热插拔（hot plugging）即“带电插拔”，指可以在计算机运行时（不关闭电源）插上或拔除硬件。热插拔最早出现在服务器领域，目的是提高服务器扩展性、灵活性和对灾难的及时恢复能力。

实现热插拔需要有几方面支持：**总线电气特性**、**主板BIOS**、**操作系统**和**设备驱动**。

目前，在服务器硬件中，可实现热插拔的部件主要有SATA硬盘（IDE不支持热插拔）、CPU、内存、风扇、USB、网卡等。

在KVM虚拟化环境中，在**不关闭客户机**的情况下，也可以对客户机的设备进行热插拔。目前，主要支持**PCI设备**、**CPU**￼、**内存**的**热插拔**。
￼
注: CPU目前不支持热拔出

# 1 PCI设备热插拔

在6.2节中介绍的VT-d设备直接分配和SR-IOV技术时都是在客户机启动时就分配相应的设备，本节将介绍可以通过热插拔来添加或删除这些PCI设备。QEMU/KVM支持动态添加和移除各种PCI设备，包括QEMU模拟的virtio类别的以及VT-d直接分配的。

PCI设备的热插拔主要需要如下几个方面的支持。

（1）BIOS

QEMU/KVM默认使用SeaBIOS￼作为客户机的BIOS，该BIOS文件路径一般为/usr/local/share/qemu/bios.bin。目前默认的BIOS已经可以支持PCI设备的热插拔。

（2）PCI总线

（对于VT-d传入的设备）物理硬件中必须有VT-d的支持，而且现在的PCI、PCIe总线都支持设备的热插拔。

（3）客户机操作系统

多数流行的Linux和Windows操作系统都支持设备的热插拔。可以在客户机的Linux系统的内核配置文件中看到一些相关的配置。以下是RHEL 7系统中的部分相关配置：

```
CONFIG_HOTPLUG_PCI_PCIE=y￼ CONFIG_HOTPLUG_PCI=y￼ CONFIG_HOTPLUG_PCI_ACPI=y￼ CONFIG_HOTPLUG_PCI_ACPI_IBM=m￼ CONFIG_HOTPLUG_PCI_SHPC=m
```

（4）客户机中的驱动程序

一些网卡驱动（如Intel的e1000e、igb、ixgbe、igbvf、ixgbevf等）、SATA或SAS磁盘驱动、USB2.0、USB3.0驱动都支持设备的热插拔。注意，在一些较旧的Linux系统（如RHEL 5.5）中需要加载“acpiphp”（使用“modprobe acpiphp”命令）这个模块后才支持设备的热插拔，否则热插拔完全不会对客户机系统生效；而较新内核的Linux系统（如RHEL 6以后、Fedora 17以后等）中已经没有该模块，不需要加载该模块，默认启动的系统就支持设备热插拔。

有了BIOS、PCI总线、客户机操作系统和驱动程序的支持后，热插拔功能只需要在QEMU monitor中使用两个命令即可完成。将一个BDF为02：00.0的PCI设备动态添加到客户机中（设置id为mydevice），在monitor中的命令如下：

```
device_add vfio-pci,host=02:00.0,id=mydevice
```

将一个设备（id为mydevice）从客户机中动态移除，在monitor中的命令如下：

```
device_del mydevice
```

这里的mydevice是在添加设备时设置的唯一标识，可以通过“info pci”命令在QEMU monitor中查看到当前的客户机中的PCI设备及其id值。在6.2.2节中也已经提及，在命令行启动客户机时分配设备也可以设置这个id值，如果这样，那么也就可以用“device_del id”命令将该PCI设备动态移除。

6.3.2　PCI设备热插拔示例

在介绍了PCI设备热插拔所需的必要条件和操作命令之后，本节分别以网卡、U盘、SATA硬盘的热插拔为例来演示具体的操作过程。

1.网卡的热插拔

