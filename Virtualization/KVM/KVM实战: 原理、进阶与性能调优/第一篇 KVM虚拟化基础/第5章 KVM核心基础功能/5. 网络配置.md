
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

* [1 用QEMU实现的网络模式](#1-用qemu实现的网络模式)
* [2 使用直接的网桥模式](#2-使用直接的网桥模式)

<!-- /code_chunk_output -->

# 1 用QEMU实现的网络模式

网络是现代计算机系统不可或缺的一部分，QEMU也对虚拟机提供了丰富的网络支持￼。通过QEMU的支持，常见的可以实现以下4种网络形式：

1）基于网桥（bridge）的虚拟网络。

2）基于NAT（Network Addresss Translation）的虚拟网络。

3）**QEMU内置！！！** 的用户模式网络（user mode networking）。

4）直接分配网络设备从而直接接入物理网络（包括VT\-d和SR\-IOV）。

这里主要讲述前3种模式，第4种网络设备的直接分配将在第6章中详细讲述。除了特别的需要iptables配置端口映射、数据包转发规则的情况，**一般默认将防火墙所有规则都关闭**，以避免妨碍客户机中的网络畅通。在实际生产环境中，可根据实际系统的特点进行配置。

在qemu命令行中，对**客户机网络**的配置（**除了网络设备直接分配**之外）都是用“\-**net**”参数进行配置的，如果没有设置任何的“\-net”参数，则**默认**使用“\-**net nic \-net user￼**”参数，进而使用完全基于**QEMU内部实现的用户模式**下的网络协议栈（将在5.5.4节详细介绍）。

在新的QEMU中，推荐用\-**device** \+ \-**netdev**组合的方式。

因为QEMU正逐渐**规范统一的设备模型的参数**使用:

- \-**device**囊括了**所有QEMU模拟的前端！！！** 的参数指定，也就是**客户机**里看到的**设备**（包括本章的网卡设备）；
- \-**netdev**指定的是**网卡模拟的后端方式！！！**，也就是本节后面要讲的各种**QEMU实现网络的方式！！！**。

本书沿用上一版的用法，依然保留**传统的\-net \+ \-net**的参数组合，但同时也会介绍等价的新方式的参数方法。

**QEMU！！！** 提供了对一系列主流和兼容性良好的网卡的模拟，通过“\-**net nic，model**=？”参数可以查询到当前的QEMU工具实现了哪些网卡的模拟。如以下实验所示：

```
[root@gerrylee ~]# qemu-system-x86_64 -net nic,model=?
Supported NIC models:
e1000
e1000-82544gc
e1000-82545em
e1000e
i82550
i82551
i82557a
i82557b
i82557c
i82558a
i82558b
i82559a
i82559b
i82559c
i82559er
i82562
i82801
ne2k_pci
pcnet
rocker
rtl8139
virtio-net-pci
virtio-net-pci-non-transitional
virtio-net-pci-transitional
vmxnet3
```

“e1000”是提供Intel e1000系列的网卡模拟，如果不显式指定，QEMU**默认**就是模拟**Intel e1000系列**的虚拟网卡。

而**virtio类型**是QEMU对**半虚拟化I/O（virtio）驱动**的支持（将会在第6章中详细介绍virtio的基本原理、配置和使用）。

qemu命令行在**不加任何网络相关的参数**启动客户机后，在客户机中可以看到它有一个**默认的e1000系列**的网卡，当然由于没有进行更多的网络配置，这个模拟的网卡虽然在客户机中可见，但是它使用的是**用户模式的网络**，其功能非常有限（将在5.5.4节中详述）。

在**客户机**中看到的e1000系列网卡如下所示，**默认**是**Intel 82540EM系列的网卡**。

```
[root@kvm-guest ~]# lspci | grep Eth￼
00:03.0 Ethernet controller: Intel Corporation 82540EM Gigabit Ethernet Controller (rev 03)
```

在QEMU monitor中用“**info qtree**”可以看到它的被模拟的详细信息。

```
...￼
dev: e1000, id ""￼
     mac = "52:54:00:12:34:56"￼
     vlan = 0￼
     netdev = "hub0port0"￼
     autonegotiation = true￼
     mitigation = true￼
     extra_mac_registers = true￼
     addr = 03.0￼
     romfile = "efi-e1000.rom"￼
     rombar = 1 (0x1)￼
     multifunction = false￼
     command_serr_enable = true￼
     x-pcie-lnksta-dllla = true￼
     class Ethernet controller, addr 00:03.0, pci id 8086:100e (sub 1af4:1100)￼
     bar 0: mem at 0xfebc0000 [0xfebdffff]￼
     bar 1: i/o at 0xc000 [0xc03f]￼
     bar 6: mem at 0xffffffffffffffff [0x3fffe]￼
......
```

qemu命令行中基本的“\-**net”参数**的细节如下：

```
-net nic[,vlan=n][,macaddr=mac][,model=type][,name=name][,addr=addr][,vectors=v]
```

执行这个命令行会让QEMU模拟出一块网卡，并将其连接到**VLAN n**上。

其中：

- “\-**net nic**”是**必需的参数**，表明这是一个**网卡的配置**。
- **vlan=n**，表示**将网卡连入VLAN n**，默认为**0**（即**没有VLAN**）。
- **macaddr=mac**，设置**网卡的MAC地址**，**默认**根据**宿主机中网卡**的地址来分配。若局域网中客户机太多，建议自己设置MAC地址，以防止MAC地址冲突。请大家在实际使用中最好配置自己的MAC地址，否则QEMU会默认分配一个相同的MAC地址（如前面info qtree代码中看到的52：54：00：12：34：56￼），几个虚拟机同时运行则可能会通过DHCP分配到相同的IP，从而引发IP地址冲突。
- model=type，设置模拟的网卡的类型，默认为e1000。
- name=name，为网卡设置一个易读的名称，该名称仅在QEMU monitor中可能用到。
- addr=addr，设置网卡在客户机中的PCI设备地址为addr。
- vectors=v，设置该网卡设备的MSI\-X向量的数量为v，该选项仅对使用virtio驱动的网卡有效。设置为“vectors=0”是关闭virtio网卡的MSI\-X中断方式。

如果需要向一个客户机提供**多个网卡**，可以**多次使用“\-net”参数**。

在宿主机中用如下命令行启动一个客户机，并使用上面的一些网络参数。

```
[root@kvm-host ~]# qemu-system-x86_64 -m 1024 rhel7.img -net nic,vlan=0,macaddr=52:54:00:12:34:22,model=e1000,addr=08 –net user
```

在客户机中用一些工具查看网卡相关的信息如下（这里使用了用户模式的网络栈，其详细介绍可参考5.5.4节），由此可知上面的网络设置都已生效。

```
[root@kvm-guest ~]# lspci | grep Eth￼
00:08.0 Ethernet controller: Intel Corporation 82540EM Gigabit Ethernet Controller (rev 03)￼
[root@kvm-guest ~]# ethtool -i eth1￼
driver: e1000￼
version: 7.3.21-k8-NAPI￼
firmware-version:￼
bus-info: 0000:00:08.0￼
[root@kvm-guest ~]# ifconfig￼
eth1      Link encap:Ethernet  HWaddr 52:54:00:12:34:22￼
          inet addr:10.0.2.15  Bcast:10.0.2.255  Mask:255.255.255.0￼
          inet6 addr: fe80::5054:ff:fe12:3422/64 Scope:Link￼
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1￼
          RX packets:10 errors:0 dropped:0 overruns:0 frame:0￼
          TX packets:47 errors:0 dropped:0 overruns:0 carrier:0￼
          collisions:0 txqueuelen:1000￼
          RX bytes:1890 (1.8 KiB)  TX bytes:6380 (6.2 KiB)￼
￼
lo        Link encap:Local Loopback￼
          inet addr:127.0.0.1  Mask:255.0.0.0￼
          inet6 addr: ::1/128 Scope:Host￼
          UP LOOPBACK RUNNING  MTU:16436  Metric:1￼
          RX packets:12 errors:0 dropped:0 overruns:0 frame:0￼
          TX packets:12 errors:0 dropped:0 overruns:0 carrier:0￼
          collisions:0 txqueuelen:0￼
          RX bytes:720 (720.0 b)  TX bytes:720 (720.0 b)
```

在QEMU monitor中查看网络的信息，如下：

```
(qemu) info network￼ VLAN 0 devices:￼     user.0: type=user,net=10.0.2.0,restrict=off￼    e1000.0: type=nic,model=e1000,macaddr=52:54:00:12:34:22￼ Devices not on any VLAN:
```

本节只介绍了网络设置的基本参数，没有详细配置具体的网络工作模式，所以这里得到的虚拟网卡在客户机中可能并不能连接到外部网络。接下来的3个小节将详细介绍各个网络工作模式的原理和配置方法。

# 2 使用直接的网桥模式

在QEMU/KVM的网络使用中，网桥（bridge）模式可以让客户机和宿主机共享一个物理网络设备连接网络，客户机有自己的独立IP地址，可以直接连接与宿主机一模一样的网络，客户机可以访问外部网络，外部网络也可以直接访问客户机（就像访问普通物理主机一样）。即使宿主机只有一个网卡设备，使用bridge模式也可让多个客户机与宿主机共享网络设备。bridge模式使用非常方便，应用也非常广泛。

virt\-manager/libvirt创建网络时，Network source（也就是后端）的“Specify shared device name”方式，就是由QEMU的bridge方式来实现的，如图5-6所示。
￼
图5\-6　libvirt Network source方式的指定
在qemu命令行中，关于配置bridge模式的网络（后端）参数如下：
