
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

* [1 用QEMU实现的网络模式](#1-用qemu实现的网络模式)

<!-- /code_chunk_output -->

# 1 用QEMU实现的网络模式

网络是现代计算机系统不可或缺的一部分，QEMU也对虚拟机提供了丰富的网络支持￼。通过QEMU的支持，常见的可以实现以下4种网络形式：

1）基于网桥（bridge）的虚拟网络。

2）基于NAT（Network Addresss Translation）的虚拟网络。

3）**QEMU内置！！！** 的用户模式网络（user mode networking）。

4）直接分配网络设备从而直接接入物理网络（包括VT\-d和SR\-IOV）。

这里主要讲述前3种模式，第4种网络设备的直接分配将在第6章中详细讲述。除了特别的需要iptables配置端口映射、数据包转发规则的情况，**一般默认将防火墙所有规则都关闭**，以避免妨碍客户机中的网络畅通。在实际生产环境中，可根据实际系统的特点进行配置。

在qemu命令行中，对**客户机网络**的配置（**除了网络设备直接分配**之外）都是用“\-**net**”参数进行配置的，如果没有设置任何的“\-net”参数，则**默认**使用“\-**net nic \-net user￼**”参数，进而使用完全基于**QEMU内部实现的用户模式**下的网络协议栈（将在5.5.4节详细介绍）。

在新的QEMU中，推荐用\-**device** \+ \-**netdev**组合的方式。

因为QEMU正逐渐**规范统一的设备模型的参数**使用:

- \-**device**囊括了**所有QEMU模拟的前端**的参数指定，也就是**客户机**里看到的**设备**（包括本章的网卡设备）；
- \-**netdev**指定的是**网卡模拟的后端方式**，也就是本节后面要讲的各种**QEMU实现网络的方式**。

本书沿用上一版的用法，依然保留**传统的\-net \+ \-net**的参数组合，但同时也会介绍等价的新方式的参数方法。

**QEMU！！！** 提供了对一系列主流和兼容性良好的网卡的模拟，通过“\-**net nic，model**=？”参数可以查询到当前的QEMU工具实现了哪些网卡的模拟。如以下实验所示：

```
[root@kvm-host linux-stable]# qemu-system-x86_64 -net nic,model=?￼
qemu: Supported NIC models: ne2k_pci,i82551,i82557b,i82559er,rtl8139,e1000,pcnet,virtio
```

“e1000”是提供Intel e1000系列的网卡模拟，如果不显式指定，QEMU**默认**就是模拟**Intel e1000系列**的虚拟网卡。而virtio类型是QEMU对半虚拟化I/O（virtio）驱动的支持（将会在第6章中详细介绍virtio的基本原理、配置和使用）。
qemu命令行在不加任何网络相关的参数启动客户机后，在客户机中可以看到它有一个默认的e1000系列的网卡，当然由于没有进行更多的网络配置，这个模拟的网卡虽然在客户机中可见，但是它使用的是用户模式的网络，其功能非常有限（将在5.5.4节中详述）。

在客户机中看到的e1000系列网卡如下所示，默认是Intel 82540EM系列的网卡。

```
[root@kvm-guest ~]# lspci | grep Eth￼
00:03.0 Ethernet controller: Intel Corporation 82540EM Gigabit Ethernet Controller (rev 03)
```

在QEMU monitor中用“info qtree”可以看到它的被模拟的详细信息。

```
...￼
dev: e1000, id ""￼
     mac = "52:54:00:12:34:56"￼
     vlan = 0￼
     netdev = "hub0port0"￼
     autonegotiation = true￼
     mitigation = true￼
     extra_mac_registers = true￼
     addr = 03.0￼
     romfile = "efi-e1000.rom"￼
     rombar = 1 (0x1)￼
     multifunction = false￼
     command_serr_enable = true￼
     x-pcie-lnksta-dllla = true￼
     class Ethernet controller, addr 00:03.0, pci id 8086:100e (sub 1af4:1100)￼
     bar 0: mem at 0xfebc0000 [0xfebdffff]￼
     bar 1: i/o at 0xc000 [0xc03f]￼
     bar 6: mem at 0xffffffffffffffff [0x3fffe]￼
......
```

qemu命令行中基本的“-net”参数的细节如下：

```
-net nic[,vlan=n][,macaddr=mac][,model=type][,name=name][,addr=addr][,vectors=v]
```

执行这个命令行会让QEMU模拟出一块网卡，并将其连接到VLAN n上。
