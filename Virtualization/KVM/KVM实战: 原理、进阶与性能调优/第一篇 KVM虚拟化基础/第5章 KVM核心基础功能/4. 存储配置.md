
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

* [1 存储配置和启动顺序](#1-存储配置和启动顺序)
	* [1.1 存储的基本配置选项](#11-存储的基本配置选项)
		* [1.1.1 \-hda file](#111-hda-file)
		* [1.1.2 \-hdb file](#112-hdb-file)
		* [1.1.3 \-hdc file](#113-hdc-file)
		* [1.1.4 \-hdd file](#114-hdd-file)
		* [1.1.5 \-fda file](#115-fda-file)
		* [1.1.6 \-fdb file](#116-fdb-file)
		* [1.1.7 \-cdrom file](#117-cdrom-file)
		* [1.1.8 \-mtdblock file](#118-mtdblock-file)
		* [1.1.9 \-sd file](#119-sd-file)
		* [1.1.10 \-pflash file](#1110-pflash-file)
	* [1.2 详细配置存储驱动器的\-drive参数](#12-详细配置存储驱动器的-drive参数)

<!-- /code_chunk_output -->

# 1 存储配置和启动顺序

QEMU提供了对多种块存储设备的模拟，包括**IDE设备**、**SCSI设备**、**软盘**、**U盘**、**virtio磁盘**等，而且对设备的启动顺序提供了灵活的配置。

## 1.1 存储的基本配置选项

在qemu命令行工具中，主要有如下的参数来配置客户机的存储。

### 1.1.1 \-hda file

将file镜像文件作为客户机中的**第1个IDE设备**（序号0），在**客户机**中表现为/**dev/hda设备**（若**客户机！！！**中使用**PIIX\_IDE驱动！！！**）或/**dev/sda**设备（若客户机中使用**ata\_piix驱动！！！**）。

如果**不指定\-hda或\-hdb等参数**，那么在前面一些例子中提到的“qemu\-system\-x86\_64 /root/kvm_demo/rhel6u3.img”就与加上\-**hda参数**来指定镜像文件的效果是一样的。

另外，也可以将**宿主机！！！**中的**一个硬盘！！！**（如/**dev/sdb**）作为\-hda的file参数来使用，从而让**整个硬盘**模拟为客户机的**第1个IDE设备**。

如果**file文件的文件名**中包含有**英文逗号（“,**”），则在书写file时应该使用**两个逗号**（因为**逗号是qemu命令行中的特殊间隔符**），如使用“\-hda my,,file”将“my,file”这个文件作为客户机的第1个IDE设备。

### 1.1.2 \-hdb file

将file作为客户机中的**第2个IDE设备**（序号1），在客户机中表现为/**dev/hdb**或/**dev/sdb**设备。

### 1.1.3 \-hdc file

将file作为客户机中的**第3个IDE设备**（序号2），在客户机中表现为/**dev/hdc**或/**dev/sdc**设备。

### 1.1.4 \-hdd file

将file作为客户机中的第4个IDE设备（序号3），在客户机中表现为/dev/hdd或/dev/sdd设备。

### 1.1.5 \-fda file

将file作为客户机中的**第1个软盘设备**（序号0），在客户机中表现为/**dev/fd0**设备。也可以将**宿主机**中的**软驱**（/dev/fd0）作为\-fda的file来使用。

### 1.1.6 \-fdb file

将file作为客户机中的**第2个软盘设备**（序号1），在客户机中表现为/dev/fd1设备。

### 1.1.7 \-cdrom file

将**file**作为**客户机**中的**光盘CD\-ROM**，在客户机中通常表现为/**dev/cdrom设备**。

也可以将**宿主机中的光驱**（/**dev/cdrom**）作为\-cdrom的file来使用。

注意，\-**cdrom**参数不能和\-**hdc参数**同时使用，因为“\-cdrom”就是**客户机**中的**第3个IDE设备！！！**。

在通过**物理光驱中的光盘**或**磁盘中ISO镜像**文件**安装客户机操作系统**时（参见3.5节），**一般会使用\-cdrom参数**。

### 1.1.8 \-mtdblock file

使用file文件作为客户机自带的一个**Flash存储器**（通常说的**闪存**）。

### 1.1.9 \-sd file

使用file文件作为客户机中的**SD卡**（Secure Digital Card）。

### 1.1.10 \-pflash file

使用file文件作为客户机的并行Flash存储器（Parallel Flash Memory）。

## 1.2 详细配置存储驱动器的\-drive参数

QEMU还提供了“\-drive”参数来**详细定义一个存储驱动器**，该参数的具体形式如下：

```
-drive option[,option[,option[,...]]]
```

为客户机定义一个新的驱动器，它有如下一些选项：

（1）file=file

使用file文件作为镜像文件加载到客户机的驱动器中。

（2）if=interface

指定驱动器使用的接口类型，可用的类型有：**ide**、**scsi**、**sd**、**mtd**、floopy、pflash、virtio，等等。

其中，除了virtio、scsi之外，其余几种类型都在本节的前面介绍过了。virtio将在第6章中介绍。

（3）bus=bus，unit=unit

设置驱动器在客户机中的总线编号和单元编号。

（4）index=index

设置在同一种接口的驱动器中的索引编号。

（5）media=media

设置驱动器中媒介的类型，其值为“disk”或“cdrom”。

（6）snapshot=snapshot

设置是否启用“\-snapshot”选项，其可选值为“on”或“off”。

当**snapshot启用**时，QEMU不会将磁盘数据的更改写回镜像文件中，而是写到临时文件中。当然可以在QEMU monitor中使用“commit”命令强制将磁盘数据的更改保存回镜像文件中。

（7）cache=cache

设置宿主机对块设备数据（包括文件或一个磁盘）访问中的cache情况，可以设置为“none”（或“off”）“writeback”“writethrough”等。其默认值是“writethrough”，即“直写模式”，它是在调用write写入数据的同时将数据写入磁盘缓存（disk cache）和后端块设备（block device）中，其优点是操作简单，其缺点是写入数据速度较慢。而“writeback”即“回写模式”，在调用write写入数据时只将数据写入磁盘缓存中即返回，只有在数据被换出缓存时才将修改的数据写到后端存储中。其优点是写入数据速度较快，其缺点是一旦更新数据在写入后端存储之前遇到系统掉电，数据会无法恢复。“writethrough”和“writeback”在读取数据时都尽量使用缓存，若设置了“cache=none”关闭缓存的方式，QEMU将在调用open系统调用打开镜像文件时使用“O_DIRECT”标识，所以其读写数据都是绕过缓存直接从块设备中读写的。一些块设备文件（如后面即将介绍的qcow2格式文件）在“writethrough”模式下性能表现很差，如果这时对性能要求比正确性更高，建议使用“writeback”模式。
（8）aio=aio
选择异步IO（Asynchronous IO）的方式，有“threads”和“native”两个值可选。其默认值为“threads”，即让一个线程池去处理异步IO。而“native”只适用于“cache=none”的情况，就是使用Linux原生的AIO。
（9）format=format
指定使用的磁盘格式，在默认情况下QEMU自动检测磁盘格式。
（10）serial=serial
指定分配给设备的序列号。
（11）addr=addr
分配给驱动器控制器的PCI地址，该选项只有在使用virtio接口时才适用。
（12）id=name
设置该驱动器的ID，这个ID可以在QEMU monitor中用“info block”看到。
（13）readonly=on|off
设置该驱动器是否只读。
3.配置客户机启动顺序的参数
前面介绍了各种存储设备的使用参数，它们在客户机中的启动顺序可以用如下的参数设定：

```
-boot [order=drives][,once=drives][,menu=on|off] [,splash=splashfile] [,splash-time=sp-time]
```

在QEMU模拟的x86 PC平台中，用“a”“b”分别表示第1个和第2个软驱，用“c”表示第1个硬盘，用“d”表示CD-ROM光驱，用“n”表示从网络启动。其中，默认从硬盘启动，要从光盘启动可以设置“-boot order=d”。“once”表示设置第1次启动的启动顺序，在系统重启（reboot）后该设置即无效，如“-boot once=d”设置表示本次从光盘启动，但系统重启后从默认的硬盘启动。“memu=on|off”用于设置交互式的启动菜单选项（前提是使用的客户机BIOS支持），它的默认值是“menu=off”，表示不开启交互式的启动菜单选择。“splash=splashfile”和“splash-time=sp-time”选项都是在“menu=on”时才有效，将名为splashfile的图片作为logo传递给BIOS来显示；而sp-time是BIOS显示splash图片的时间，其单位是毫秒（ms）。图5-5展示了在使用“-boot order=dc，menu=on”设置后，在客户机启动窗口中按F12键进入的启动菜单。
4.存储配置的示例
在介绍完基本的参数与启动顺序后，通过示例来看一下磁盘实际配置和在客户机中的效果。通过如下的3个等价命令之一启动一个客户机。

qemu-system-x86_64 -m 1024 -smp 2 rhel7.img￼ qemu-system-x86_64 -m 1024 -smp 2 -hda rhel7.img￼ qemu-system-x86_64 -m 1024 -smp 2 -drive file=rhel7.img,if=ide

￼
图5-5　进入启动菜单
然后在客户机中查看磁盘情况，如下：