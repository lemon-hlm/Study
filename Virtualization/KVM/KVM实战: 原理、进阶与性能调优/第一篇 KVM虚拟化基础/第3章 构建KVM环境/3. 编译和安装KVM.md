
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

* [1 下载KVM源代码](#1-下载kvm源代码)
	* [1.1 下载kvm.git](#11-下载kvmgit)
	* [1.2 下载linux.git](#12-下载linuxgit)

<!-- /code_chunk_output -->

# 1 下载KVM源代码

KVM作为Linux kernel中的一个module而存在，是从Linux2.6.20版本开始被完全正式加入到内核的主干开发和正式发布代码中。所以，只需要下载2.6.20版本之后**Linux kernel代码**即可编译和使用KVM。如果是学习KVM，推荐使用最新正式发布或者正在开发中的kernel版本。

下载最新KVM源代码，主要有如下三种方式：

- 下载KVM项目开发中的代码仓库kvm.git。
- 下载Linux内核的代码仓库linux.git。
- 打包下载Linux内核的源代码（Tarball格式）。

## 1.1 下载kvm.git

**KVM项目的代码**是托管在Linux内核官方源码网站 http://git.kernel.org 上的，可以到上面去查看和下载。

该网页上 virt/kvm/kvm.git 即是KVM项目的代码，它是**最新的功能最丰富的KVM源代码库**（尽管并非最稳定的）。

目前，kvm.git的最主要维护者（maintainer）是来自Redhat公司的Radim Krcmár和Paolo Bonzini。

从 http://git.kernel.org/?p=virt/kvm/kvm.git 网页可以看到，kvm.git下载链接有如下3个URL，可用于下载最新的KVM的开发代码仓库。

```
git://git.kernel.org/pub/scm/virt/kvm/kvm.git
https://git.kernel.org/pub/scm/virt/kvm/kvm.git
https://kernel.googlesource.com/pub/scm/virt/kvm/kvm.git
```

## 1.2 下载linux.git

Linux内核的官方网站为 http://kernel.org ，其中源代码管理网为 http://git.kernel.org ，可以在此网站上找到最新的 linux.git 代码。在源码管理网站上，我们看到有多个 linux.git ，我们选择Linus Torvalds的源码库（也即是Linux内核的主干）。在内核源码的网页 http://git.kernel.org/?p=linux/kernel/git/torvalds/linux.git 中可以看到，其源码仓库也有如下3个链接可用：

```
git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
https://kernel.googlesource.com/pub/scm/linux/kernel/git/torvalds/linux.git
```

3. 下载Linux的Tarball（打包工具的意思）

在Linux官方网站（ http://kernel.org/ ）上，也提供Linux内核的Tarball文件下载；除了在其首页上单击一些Tarball之外，也可以到如下网址下载Linux内核的各个版本的Tarball。

```
ftp://ftp.kernel.org/pub/linux/kernel/
http://www.kernel.org/pub/linux/kernel/
```

kernel.org还提供一种rsync的方式下载，此处不详细叙述，请参见其官网首页的提示。

4. 通过kernel.org的镜像站点下载

包括国内外的一些镜像站点

国内有名镜像站点有

清华大学开源镜像站： http://mirror.tuna.tsinghua.edu.cn/ ， 其中的链接地址 http://mirror.tuna.tsinghua.edu.cn/kernel/linux/kernel/ 与 http://www.kernel.org/pub/linux/kernel/ 就是同步的，用起来比较方便。

北京交通大学开源镜像站： 
http://mirror.bjtu.edu.cn/kernel/linux/kernel/

还有如下两个镜像站可以推荐给大家：

网易开源镜像站，http://mirrors.163.com/

搜狐开源镜像站，http://mirrors.sohu.com/


3.2 配置KVM

上面方式下载的源代码都是可以同样地进行配置和编译，本章以开发中的最新源代码仓库kvm.git来讲解KVM的配置和编译等。KVM是作为Linux内核中的一个module存在的，而 kvm.git 是一个包含了最新的KVM模块开发中代码完整的Linux内核源码仓库。它的配置方式，与普通的Linux内核配置完全一样，只是需要注意将KVM相关的配置选择为编译进内核或者编译为模块。

在kvm.git（Linux kernel）代码目录下，运行"make help"命令可以得到一些关于如何配置和编译kernel的帮助手册，命令行如下：

![命令](images/8.png)

对KVM或Linux内核配置时常用的配置命令的一些解释如下：

（1）make config

基于文本的最为传统的也是最为枯燥的一种配置方式，但是它可以适用于任何情况之下。

（2）make oldconfig

make oldconfig和make config类似，但是它的作用是在现有的内核设置文件基础上建立一个新的设置文件，只会向用户提供有关新内核特性的问题，在新内核升级的过程中，make oldconfig非常有用，用户将现有的配置文件.config复制到新内核的源码中，执行make oldconfig，此时，用户只需要回答那些针对新增特性的问题。

（3）make silentoldconfig

和上面make oldconfig一样，但在屏幕上不再出现已在.config中配置好的选项。

（4）make menuconfig

基于终端的一种配置方式，提供了文本模式的图形用户界面，用户可以通过光标移动来浏览所支持的各种特性。使用这用配置方式时，系统中必须安装有ncurses库，否则会显示"Unable to find the ncurses libraries"的错误提示。其中"y"、"n"、"m"、“？”键的选择功能与前面make config中介绍的一致。

（5）make xconfig

基于XWindow的一种配置方式，提供了漂亮的配置窗口，不过只有能够在X Server上运行X桌面应用程序时才能够使用，它依赖于QT，如果系统中没有安装QT库，则会出现"Unable to find any QT installation"的错误提示。

（6）make gconfig

与make xconfig类似，不同的是make gconfig依赖于GTK库。

（7）make defconfig

按照内核代码中提供的默认配置文件对内核进行配置（在Intel x86\_64平台上，默认配置为arch/x86/configs/x86_64_defconfig），生成.config文件可以用作初始化配置，然后再使用make menuconfig进行定制化配置。

（8）make allyesconfig

尽可能多地使用"y"设置内核选项值，生成的配置中包含了全部的内核特性。

（9）make allnoconfig

除必须的选项外，其他选项一律不选(常用于嵌入式Linux系统的编译)。

（10）make allmodconfig

尽可能多地使用"m"设置内核选项值来生成配置文件。

（11）make localmodconfig

会执行lsmod命令查看当前系统中加载了哪些模块(Modules)，并将原来的.config中不需要的模块去掉，仅保留前面lsmod命令查出来的这些模块，从而简化了内核的配置过程。这样做确实方便了很多，但是也有个缺点：该方法仅能使编译出的内核支持当前内核已经加载的模块。因为该方法使用的是lsmod查询得到的结果，如果有的模块当前没有加载，那么就不会编到新的内核中。

下面以make menuconfig为例介绍一下如何选择KVM相关的配置。运行make menuconfig后显示的界面如图所示。

![make menuconfig命令的选择界面](images/9.png)

选择了Virtualization之后，进入其中进行详细配置，包括选中KVM、选中对处理器的支持（比如：KVM for Intel processors support，KVM for AMD processors support）等，如图所示。

![Virtualization中的配置选项](images/10.png)

在配置完成之后，就会在kvm.git的目录下面生成一个.config文件，最好检查一下KVM相关的配置是否正确。在本次配置中，与KVM直接相关的几个配置项的主要情况如下：

![config](images/11.png)

3.3 编译KVM

KVM编译过程就完全是一个普通Linux内核编译过程，需要经过编译kernel、编译bzImage和编译module等三个步骤。编译bzImage这一步不是必须的，在本章示例中，config中使用了initramfs，所以这里需要这个bzImage用于生成initramfs image。根据Makefile中的定义可以看出，直接执行"make"或"make all"命令就可以将这里提及的3个步骤全部包括在内。

第一步，编译kernel的命令为“make vmlinux”，如下：

![make vmlinux](images/12.png)

编译命令中"-j"参数并非必须的，它是让make工具用多进程来编译，比如上面命令中提到的"-j 20"，会让make工具最多创建20个GCC进程同时来执行编译任务。在一个比较空闲的系统上面，有一个推荐值作为-j参数的值，即大约为2倍于系统上的CPU的core的数量（CPU超线程也算core）。

第二步，执行编译bzImage的命令“make bzImage”，其输出为：

![make bzImage](images/13.png)

第三步，编译kernel和bzImage之后编译内核的模块，命令为“make modules”，输出如下：

![make modules](images/14.png)

3.4 安装KVM

KVM安装包括两步骤：module安装、kernel与initramfs的安装。

（1） 安装module

通过"make modules_install"命令可以将编译好的module安装到相应的目录之中，在默认情况下module被安装到/lib/modules/$kernel_version/kernel目录之中。

![make modules_install](images/15.png)

安装好module之后，可以查看下相应的安装路径，可以看到kvm模块已经安装。如下：

![安装目录](images/15_2.png)

（2） 安装kernel和initramfs

通过“make install”可以安装kernel和initramfs，命令输出如下：

![make install](images/16.png)

可见，在/boot目录下生成了内核（vmlinuz）和initramfs等内核启动所需的文件。

在运行make install之后，grub配置文件（如：/boot/grub/grub.conf）中也自动添加了一个grub选项，如下所示：

![grub选项](images/17.png)

检查了grub之后，重新启动系统，选择刚才为了KVM而编译、安装的内核启动。

系统启动后，登录进入系统，在通常情况下，系统启动时默认已经加载了kvm和kvm_intel这两个模块；如果没有加载，请手动用modprobe命令依次加载kvm和kvm_intel模块。

![kvm相关模块](images/18.png)

确认KVM相关的模块加载成功后，检查/dev/kvm这个文件，它是kvm内核模块提供给用户空间的qemu-kvm程序使用的一个控制接口，它提供了客户机（Guest）操作系统运行所需要的模拟和实际的硬件设备环境。