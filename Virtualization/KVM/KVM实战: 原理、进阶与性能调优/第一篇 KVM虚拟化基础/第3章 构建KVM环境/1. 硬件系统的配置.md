
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

* [1 处理器架构的支持](#1-处理器架构的支持)
	* [1.1 x86\-64架构](#11-x86-64架构)
* [2 硬件的支持](#2-硬件的支持)
	* [2.1 CPU硬件以及BIOS设置](#21-cpu硬件以及bios设置)
		* [2.1.1 VT](#211-vt)
		* [2.1.2 VT\-d](#212-vt-d)
		* [2.1.3 BIOS设置](#213-bios设置)
		* [2.1.4 系统检查](#214-系统检查)

<!-- /code_chunk_output -->

**KVM**从诞生伊始就**需要硬件虚拟化扩展**的支持，所以这里需要特别讲解一下硬件系统的配置。

# 1 处理器架构的支持

KVM最初始的开发是**基于x86和x86\-64处理器架构**上的**Linux系统**进行的，目前，KVM被移植到**多种不同处理器架构**之上，包括**AIM联盟**（**Apple\–IBM\–Motorola**）的**PowerPC架构**、IBM的**S/390架构**、**ARM架构**（2012年开始￼）等。其中，在x86\-64上面的功能支持是最完善的（主要原因是Intel/AMD的x86\-64架构在桌面和服务器市场上的主导地位及其架构的开放性，以及它的开发者众多），本书也采用基于Intel x86\-64架构的处理器作为基本的硬件环境￼。

## 1.1 x86\-64架构

在x86\-64架构的处理器中，KVM需要的**硬件虚拟化扩展**分别为**Intel的虚拟化技术（Intel VT**）和**AMD的AMD\-V技术**。

其中，Intel在**2005**年11月发布的**奔腾四处理器**（型号：662和672）中第一次正式支持VT技术（Virtualization Technology），之后不久的**2006**年5月**AMD**也发布了**支持AMD\-V**的处理器。

# 2 硬件的支持

现在比较流行的针对服务器和桌面的Intel处理器多数都是支持VT技术的，本节着重讲述与英特尔的VT技术相关的硬件设置。

## 2.1 CPU硬件以及BIOS设置

### 2.1.1 VT

首先**处理器（CPU**）要在**硬件上支持VT**技术，还要在**BIOS**中将其**功能打开**，KVM才能使用到。目前，多数流行的服务器和部分桌面处理器的BIOS都默认将VT打开了。

在**BIOS**中，VT的选项通过“Advanced→Processor Configuration”来查看和设置，它的标识通常为“**Intel(R)Virtualization Technology**”或“**Intel VT**”等类似的文字说明。

### 2.1.2 VT\-d

除了支持必需的处理器虚拟化扩展以外，如果服务器芯片还支持**VT\-d（Virtualization Technology for Directed I/O**），建议在BIOS中将其打开，因为后面一些相对高级的设备的直接分配功能会需要硬件VT\-d技术的支持。VT\-d是对设备I/O的虚拟化硬件支持，在BIOS中的位置可能为“Advanced→Processor Configuration”或“Advanced→System Agent(SA)Configuration”，它在BIOS中的标志一般为“**Intel(R)VT for Directed I/O**”或“**Intel VT\-d**”。

### 2.1.3 BIOS设置

下面以一台Intel Haswell\-UP平台的服务器为例，来说明在BIOS中的设置。

BIOS中Enabled的VT和VT\-d选项，如图3-2所示。
￼
![](./images/2019-05-15-09-02-49.png)

对于不同平台或不同厂商的BIOS，VT和VT\-d等设置的位置可能是不一样的，需要根据实际的硬件情况和BIOS中的选项来灵活设置。

### 2.1.4 系统检查

设置好了VT和VT\-d的相关选项，保存BIOS的设置并退出，系统重启后生效。在Linux系统中，可以通过检查/proc/cpuinfo文件中的CPU特性标志（flags）来查看CPU目前是否支持硬件虚拟化。

在x86和x86\-64平台中，**Intel**系列**CPU支持虚拟化**的标志为“**vmx**”，**AMD**系列CPU的标志为“**svm**”。

所以可以用以下命令行查看“vmx”或者“svm”标志：

```
[root@kvm-host ~]# grep -E "svm|vmx" /proc/cpuinfo ￼
flags   : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc aperfmperf eagerfpu pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 fma cx16 xtpr pdcm pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand lahf_lm abm ida arat epb pln pts dtherm tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 avx2 smep bmi2 erms invpcid xsaveopt ￼
<!-– 此处省略多行其余CPU或core的flags输出信息 -->
```

对于内存虚拟化**EPT**以及**vpid**的支持查询

```
[root@kvm-host ~]# grep -E “ept|vpid” /proc/cpuinfo ￼

```