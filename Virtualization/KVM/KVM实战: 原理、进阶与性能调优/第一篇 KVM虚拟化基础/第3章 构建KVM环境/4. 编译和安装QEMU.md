
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

* [1 曾经的qemu\-kvm](#1-曾经的qemu-kvm)
* [2 下载QEMU源代码](#2-下载qemu源代码)
* [3 配置和编译QEMU](#3-配置和编译qemu)

<!-- /code_chunk_output -->

除了在内核空间的KVM模块之外，在用户空间需要QEMU￼来模拟所需要的CPU和设备模型，以及启动客户机进程，这样才有了一个完整的KVM运行环境。

在编译和安装了KVM并且启动到编译的内核之后，下面来看一下QEMU的编译和安装。

# 1 曾经的qemu\-kvm

在上一版中，我们是以qemu\-kvm为例来讲解QEMU/KVM的。qemu-kvm原本是kernel社区维护的**专门用于KVM的QEMU的分支**。

在**2012年**年末的时候，这个分支**并入了主流的QEMU**（ git://git.qemu-project.org/qemu.git ）。从此，不再需要特殊的qemu-kvm，而只是**通用的QEMU**加上\-\-**enable\-kvm**选项就可以创建KVM guest了。

# 2 下载QEMU源代码

在并入主流QEMU以后，目前的QEMU项目针对KVM/x86的部分依然是由Redhat公司的Paolo Bonzini作为维护者（Maintainer），代码的**git url**托管在 https://git.qemu.org/ 上。

**QEMU开发代码仓库**的网页连接为：http://git.qemu.org/qemu.git 。
其中，可以看到有如下2个URL链接可供下载开发中的最新qemu-kvm的代码仓库。

```
git://git.qemu.org/qemu.git￼
http://git.qemu.org/git/qemu.git
```

可以根据自己实际需要选择当中任一个，用git clone命令下载即可，它们是完全一样的。

另外，也可以到以下下载链接中根据需要下载**最近几个发布版本的代码压缩包**。

https://www.qemu.org/download/

在本节后面讲解编译时，是以下载开发中的最新的qemu.git为例的。获取其代码仓库过程如下：

```
[root@kvm-host ~]# git clone git://git.qemu.org/qemu.git￼
```

# 3 配置和编译QEMU

QEMU的配置并不复杂，通常情况下，**直接运行代码仓库中configure文件**进行配置即可。

当然，如果对其配置不熟悉，可以运行“./B”命令查看配置的一些选项及其帮助信息。
显示配置的帮助信息如下：

```
[root@kvm-host qemu]# ./configure --help

Usage: configure [options]
Options: [defaults in brackets after descriptions]

Standard options:
  --help                   print this message
  --prefix=PREFIX          install in PREFIX [/usr/local]
  --interp-prefix=PREFIX   where to find shared libraries, etc.
                           use %M for cpu name [/usr/gnemul/qemu-%M]
  --target-list=LIST       set target list (default: build everything)
                           Available targets: aarch64-softmmu alpha-softmmu
                           arm-softmmu cris-softmmu hppa-softmmu i386-softmmu
                           lm32-softmmu m68k-softmmu microblaze-softmmu
                           microblazeel-softmmu mips-softmmu mips64-softmmu
                           mips64el-softmmu mipsel-softmmu moxie-softmmu
                           nios2-softmmu or1k-softmmu ppc-softmmu ppc64-softmmu
                           riscv32-softmmu riscv64-softmmu s390x-softmmu
                           sh4-softmmu sh4eb-softmmu sparc-softmmu
                           sparc64-softmmu tricore-softmmu unicore32-softmmu
                           x86_64-softmmu xtensa-softmmu xtensaeb-softmmu
  --target-list-exclude=LIST exclude a set of targets from the default target-list
...
```

以上configure选项中我们特别提一下“\-\-**target\-list**”，它指定**QEMU对客户机架构**的支持。

可以看到，对应的选项非常多，表面上QEMU对客户机的架构类型的支持是非常全面的。由于在本书中（也是多数的实际使用场景）我们只使用x86架构的客户机，因此指定“\-\-target\-list=x86\_64\-softmmu”，可以节省大量的编译时间。

执行configure文件进行配置的过程如下：

```
# ./configure --target-list=x86_64-softmmu
```

