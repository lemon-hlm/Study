
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

* [1 libvirt简介](#1-libvirt简介)
	* [1.1 多种虚拟化方案支持](#11-多种虚拟化方案支持)
	* [1.2 LGPL许可证](#12-lgpl许可证)
	* [1.3 编程语言支持、AMQP和加密认证](#13-编程语言支持-amqp和加密认证)
	* [1.4 基本架构](#14-基本架构)
	* [1.5 重要概念](#15-重要概念)
	* [1.6 管理功能](#16-管理功能)
		* [1.6.1 域的管理](#161-域的管理)
		* [1.6.2 远程节点的管理](#162-远程节点的管理)
		* [1.6.3 存储的管理](#163-存储的管理)
		* [1.6.4 网络的管理](#164-网络的管理)
		* [1.6.5 应用程序接口](#165-应用程序接口)
	* [1.7 libvirt组成](#17-libvirt组成)
* [2 libvirt的安装与配置](#2-libvirt的安装与配置)
	* [2.1 libvirt安装](#21-libvirt安装)
	* [2.2 libvirt的配置文件](#22-libvirt的配置文件)
		* [2.2.1 /etc/libvirt/libvirt.conf](#221-etclibvirtlibvirtconf)
		* [2.2.2 /etc/libvirt/libvirtd.conf](#222-etclibvirtlibvirtdconf)
		* [2.2.3 /etc/libvirt/qemu.conf](#223-etclibvirtqemuconf)

<!-- /code_chunk_output -->

# 1 libvirt简介

提到KVM的管理工具，首先不得不介绍的就是大名鼎鼎的**libvirt**，因为libvirt是目前使用最为广泛的对KVM虚拟机进行管理的工具和应用程序接口，而且一些常用的虚拟机管理工具（如**virsh**、**virt\-install**、**virt\-manager**等）和云计算框架平台（如OpenStack、ZStack、OpenNebula、Eucalyptus等）都在**底层使用libvirt的应用程序接口**。

libvirt是为了更方便地管理平台虚拟化技术而设计的开放源代码的应用程序接口、守护进程和管理工具，它不仅提供了对**虚拟化客户机的管理**，也提供了对**虚拟化网络和存储的管理！！！**。

## 1.1 多种虚拟化方案支持

libvirt支持**多种虚拟化方案**，既支持包括**KVM**、**QEMU**、**Xen**、**VMware**、**VirtualBox**、**Hyper\-V**等在内的**平台虚拟化方案**，也支持**OpenVZ**、**LXC**等**Linux容器虚拟化系统！！！**，还支持**用户态Linux（UML！！！**）的**虚拟化**。

## 1.2 LGPL许可证

libvirt是一个免费的开源的软件，使用的许可证是LGPL￼（**GNU宽松的通用公共许可证**），使用libvirt库进行链接的软件程序**不一定要选择开源和遵守GPL许可证**。和KVM、Xen等开源项目类似，libvirt也有自己的开发者社区，而且随着虚拟化、云计算等成为近年来的技术热点，libvirt项目的社区也比较活跃。目前，libvirt的开发主要由Redhat公司作为强大的支持，由于Redhat公司在虚拟化方面逐渐偏向于支持KVM（而不是Xen），故libvirt对QEMU/KVM的支持是非常成熟和稳定的。当然，IBM、Novell等公司以及众多的个人开发者对libvirt项目的代码贡献量也是非常大的。

## 1.3 编程语言支持、AMQP和加密认证

libvirt本身提供了一套较为稳定的**C语言应用程序接口**，目前，在其他一些流行的**编程语言**中也提供了对libvirt的绑定，在Python、Perl、Java、Ruby、PHP、OCaml等高级编程语言中已经有**libvirt的程序库**可以直接使用。libvirt还提供了为基于**AMQP（高级消息队列协议**）的**消息系统**（如Apache Qpid）提供**QMF代理**，这可以让云计算管理系统中**宿主机与客户机**、**客户机与客户机**之间的消息通信变得更易于实现。libvirt还为安全地**远程管理虚拟客户机**提供了**加密和认证**等安全措施。

正是由于libvirt拥有这些强大的功能和较为稳定的应用程序接口，而且它的许可证（license）也比较宽松，所以libvirt的应用程序接口已被广泛地用在基于虚拟化和云计算的解决方案中，主要作为**连接底层Hypervisor**和**上层应用程序**的一个**中间适配层**。

## 1.4 基本架构

libvirt对多种不同的Hypervisor的支持是通过一种**基于驱动程序的架构**来实现的。libvirt对**不同的Hypervisor**提供了**不同的驱动**：对Xen有Xen的驱动，对QEMU/KVM有QEMU驱动，对VMware有VMware驱动。在libvirt源代码中，可以很容易找到**qemu\_driver.c**、**xen\_driver.c**、**xenapi\_driver.c**、**VMware\_driver.c**、**vbox\_driver.c**这样的驱动程序源代码文件。

libvirt作为中间适配层，可以让底层Hypervisor对上层用户空间的管理工具是完全透明的，因为libvirt屏蔽了底层各种Hypervisor的细节，为上层管理工具提供了一个统一的、较稳定的接口（API）。通过libvirt，一些用户空间管理工具可以管理各种不同的Hypervisor和上面运行的客户机，它们之间基本的交互框架如图4-1所示。

![](./images/2019-05-16-09-07-13.png)

## 1.5 重要概念

在libvirt中涉及几个重要的概念，解释如下：

- **节点（Node**）是一个**物理机器**，上面可能运行着多个虚拟客户机。Hypervisor和Domain都运行在节点上。
- **Hypervisor**也称**虚拟机监控器（VMM**），如KVM、Xen、VMware、Hyper\-V等，是**虚拟化中的一个底层软件层**，它可以虚拟化一个节点让其运行多个虚拟客户机（不同客户机可能有不同的配置和操作系统）。
- **域（Domain**）是在Hypervisor上运行的一个**客户机操作系统实例**。域也被称为实例（instance，如在亚马逊的AWS云计算服务中客户机就被称为实例）、客户机操作系统（guest OS）、虚拟机（virtual machine），它们都是指同一个概念。

节点、Hypervisor和域的关系可以简单地用图4\-2来表示。
￼
![](./images/2019-05-16-09-10-58.png)

## 1.6 管理功能

在了解了节点、Hypervisor和域的概念之后，用一句话概括libvirt的目标，那就是：为了**安全高效地管理节点上的各个域**，而提供一个**公共的稳定的软件层**。当然，这里的管理，既包括**本地的管理**，也包含**远程的管理**。

具体地讲，libvirt的**管理功能**主要包含如下5个部分。

### 1.6.1 域的管理

1）**域的管理**。

包括对节点上的域的各个**生命周期的管理**，如启动、停止、暂停、保存、恢复和**动态迁移**。还包括对**多种设备类型**的**热插拔操作**，包括磁盘、网卡、内存和CPU。当然不同的Hypervisor上对这些热插拔的支持程度有所不同。

### 1.6.2 远程节点的管理

2）**远程节点的管理**。

只要**物理节点**上运行了**libvirtd这个守护进程**，远程的管理程序就可以连接到该节点进程管理操作，经过认证和授权之后，**所有的libvirt功能**都可以被访问和使用。libvirt支持**多种网络远程传输类型**，如**SSH**、**TCP套接字**、**Unix domain socket**、**TLS的加密传输**等。假设使用了最简单的SSH，不需要额外的配置工作，比如，在example.com节点上运行了libvirtd，而且允许SSH访问，在远程的某台管理机器上就可以用如下的命令行来连接到example.com上，从而管理其上的域。

```
virsh -c qemu+ssh://root@example.com/system
```

### 1.6.3 存储的管理

3）**存储的管理**。

任何运行了**libvirtd守护进程的主机！！！**，都可以通过**libvirt**来管理**不同类型的存储**，如创建不同格式的客户机镜像（qcow2、raw、qde、vmdk等）、挂载NFS共享存储系统、查看现有的LVM卷组、创建新的LVM卷组和逻辑卷、对磁盘设备分区、挂载iSCSI共享存储、使用Ceph系统支持的RBD远程存储，等等。

当然在libvirt中，对存储的管理也是支持远程的。

### 1.6.4 网络的管理

4）**网络的管理**。

任何运行了**libvirtd守护进程的主机**，都可以通过libvirt来管理**物理的和逻辑的网络接口**。包括列出现有的网络接口卡，配置网络接口，创建虚拟网络接口，网络接口的桥接，VLAN管理，NAT网络设置，为客户机分配虚拟网络接口，等等。

### 1.6.5 应用程序接口

5）提供一个稳定、可靠、高效的**应用程序接口**，以便可以完成前面的4个管理功能。

## 1.7 libvirt组成

libvirt主要由3个部分组成，分别是：**应用程序编程接口库**、**一个守护进程（libvirtd**）和**一个默认命令行管理工具（virsh**）。

- **应用程序接口**是为其他虚拟机管理工具（如virsh、virt-manager等）提供虚拟机管理的**程序库支持**。
- **libvirtd守护进程**负责执行对节点上的**域的管理**工作，在用各种工具对虚拟机进行管理时，这个守护进程一定要处于**运行状态**中。而且这个守护进程可以分为两种：
    - 一种是**root权限**的**libvirtd**，其权限较大，可以完成所有支持的管理工作；
    - 一种是**普通用户权限**的**libvirtd**，只能完成比较受限的管理工作。
- virsh是libvirt项目中默认的对虚拟机管理的一个命令行工具，将在4.2节中详细介绍。

# 2 libvirt的安装与配置

## 2.1 libvirt安装

RHEL 系列中可以使用yum或rpm工具来安装对应的RPM包。

查看某系统中已经安装的libvirt相关的RPM包，命令行如下：

```
# rpm -qa | grep libvirt
# yum install libvirt
```

当然，RHEL 7.3**默认采用QEMU/KVM的虚拟化方案**，所以应该安装QEMU相关的软件包。查看这些软件包的命令行操作如下：

```
[root@localhost qemu]# rpm -qa | grep '^qemu'
qemu-kvm-1.5.3-160.el7_6.1.x86_64
qemu-kvm-common-1.5.3-160.el7_6.1.x86_64
qemu-guest-agent-2.12.0-2.el7.x86_64
qemu-img-1.5.3-160.el7_6.1.x86_64

# 安装时, 运行yum install qemu-kvm即可
```

由于libvirt是跨平台的，而且还支持微软公司的**Hyper\-V虚拟化**，所以在Windows上也可以安装libvirt，甚至可以编译libvirt。可以到libvirt官方的网页（ https://libvirt.org/windows.html ）中查看更多关于libvirt对Windows的支持。

## 2.2 libvirt的配置文件

以RHEL 7.3为例，libvirt相关的配置文件都在/etc/libvirt/目录之中，如下：

```
[root@localhost qemu]# ll /etc/libvirt/
总用量 80
-rw-r--r--  1 root root   450 4月  24 22:07 libvirt-admin.conf
-rw-r--r--  1 root root   547 4月  24 22:07 libvirt.conf
-rw-r--r--  1 root root 16529 4月  24 22:07 libvirtd.conf
-rw-r--r--  1 root root  1175 4月  24 22:07 lxc.conf
drwx------. 2 root root  4096 5月  15 19:51 nwfilter
drwx------. 3 root root    22 4月  24 22:07 qemu
-rw-r--r--  1 root root 30306 4月  24 22:07 qemu.conf
-rw-r--r--  1 root root  2169 4月  24 22:07 qemu-lockd.conf
drwx------. 2 root root     6 3月   1 09:39 secrets
-rw-r--r--  1 root root  3202 4月  24 22:07 virtlockd.conf
-rw-r--r--  1 root root  3247 4月  24 22:07 virtlogd.conf
[root@localhost qemu]# ll /etc/libvirt/qemu
总用量 0
drwx------. 3 root root 42 4月  24 22:07 networks
```

下面简单介绍其中几个重要的配置文件和目录。

### 2.2.1 /etc/libvirt/libvirt.conf

libvirt.conf文件用于配置一些**常用libvirt连接（通常是远程连接）的别名**。和Linux中的普通配置文件一样，在该配置文件中以井号（#）开头的行是注释，如下：

```
[root@localhost libvirt]# cat /etc/libvirt/libvirt.conf
#
# This can be used to setup URI aliases for frequently
# used connection URIs. Aliases may contain only the
# characters  a-Z, 0-9, _, -.
#
# Following the '=' may be any valid libvirt connection
# URI, including arbitrary parameters

#uri_aliases = [
#  "hail=qemu+ssh://root@hail.cloud.example.com/system",
#  "sleet=qemu+ssh://root@sleet.cloud.example.com/system",
#]

#
# These can be used in cases when no URI is supplied by the application
# (@uri_default also prevents probing of the hypervisor driver).
#
#uri_default = "qemu:///system"
#为了演示目录，配置了如下这个别名￼
uri_aliases = [￼
    "remote1=qemu+ssh://root@192.168.93.201/system",￼
]
```

其中，配置了remote1这个别名，用于指代 qemu+ssh//root@192.168.93.201/system 这个远程的libvirt连接。有这个别名后，就可以在用**virsh等工具**或自己写**代码调用libvirt API**时使用这个别名，而不需要写完整的、冗长的URI连接标识了。

用virsh使用这个别名，连接到远程的libvirt上查询当前已经启动的客户机状态，然后退出连接。命令行操作如下：

```
[root@kvm-host kvm_demo]# systemctl reload libvirtd￼
[root@kvm-host kvm_demo]# virsh -c remote1￼
root@192.168.93.201's password:￼
Welcome to virsh, the virtualization interactive terminal.￼

Type:  'help' for help with commands￼
       'quit' to quit￼

virsh # list￼
 Id    Name                           State￼
 ----------------------------------------------------￼
 1     rhel7u2-remote                 running￼

virsh # quit￼

[root@kvm-host kvm_demo]#
```

在代码中调用libvirt API时也可以使用这个别名来建立连接，如下的python代码行就实现了使用这个别名来建立连接。

```
conn = libvirt.openReadOnly('remote1')
```

### 2.2.2 /etc/libvirt/libvirtd.conf

libvirtd.conf是libvirt的**守护进程libvirtd的配置文件**，被修改后需要让**libvirtd重新加载配置文件**（或**重启libvirtd**）才会生效。

在libvirtd.conf文件中，用井号（#）开头的行是注释内容，真正有用的配置在文件的每一行中使用“**配置项=值**”（如tcp_port="16509"）这样配对的格式来设置。

在libvirtd.conf中配置了libvirtd启动时的许多设置，包括是否建立TCP、UNIX domain socket等连接方式及其最大连接数，以及这些连接的认证机制，设置libvirtd的日志级别等。

例如，下面的几个配置项表示

- **关闭TLS安全认证的连接**（默认值是打开的），
- **打开TCP连接**（默认是关闭TCP连接的），
- 设置TCP监听的端口，
- 设置UNIX domain socket的保存目录
- TCP连接不使用认证授权方式

```
listen_tls = 0￼
listen_tcp = 1￼
tcp_port = "16666"￼
unix_sock_dir = "/var/run/libvirt"￼
auth_tcp = "none"
```
>
>注意:
>要让**TCP、TLS等连接生效**，需要在**启动libvirtd**时加上\-\-**listen参数**（简写为\-l）。而**默认的systemctl start libvirtd**命令在启动libvirtd服务时并**没带\-\-listen**参数。所以如果要使用TCP等连接方式，可以使用libvirtd \-\-listen \-d命令来启动libvirtd。

以上配置选项实现将**UNIX socket**放到/**var/run/libvirt目录**下，启动libvirtd并检验配置是否生效。命令行操作如下：

```
[root@kvm-host ~]# libvirtd --listen -d￼

[root@kvm-host ~]# virsh -c qemu+tcp://localhost:16666/system￼
Welcome to virsh, the virtualization interactive terminal.￼

Type:  'help' for help with commands￼
       'quit' to quit￼
       
virsh # quit￼

[root@kvm-host ~]# ls /var/run/libvirt/libvirt-sock*￼
/var/run/libvirt/libvirt-sock  /var/run/libvirt/libvirt-sock-ro
```

### 2.2.3 /etc/libvirt/qemu.conf

qemu.conf是libvirt对QEMU的驱动的配置文件，包括VNC、SPICE等，以及连接它们时采用的权限认证方式的配置，也包括内存大页、SELinux、Cgroups等相关配置。

（4）/etc/libvirt/qemu/目录
在qemu目录下存放的是使用QEMU驱动的域的配置文件。查看qemu目录如下：

[root@kvm-host ~]# ls /etc/libvirt/qemu/￼ networks centos7u2-1.xml centos7u2-2.xml

其中包括了两个域的XML配置文件（centos7u2-1.xml和centos7u2-2.xml），这就是笔者用virt-manager工具创建的两个域，默认会将其配置文件保存到/etc/libvirt/qemu/目录下。而其中的networks目录保存了创建一个域时默认使用的网络配置。
3.libvirtd的使用
libvirtd是一个作为libvirt虚拟化管理系统中的服务器端的守护程序，要让某个节点能够利用libvirt进行管理（无论是本地还是远程管理），都需要在这个节点上运行libvirtd这个守护进程，以便让其他上层管理工具可以连接到该节点，libvirtd负责执行其他管理工具发送给它的虚拟化管理操作指令。而libvirt的客户端工具（包括virsh、virt-manager等）可以连接到本地或远程的libvirtd进程，以便管理节点上的客户机（启动、关闭、重启、迁移等）、收集节点上的宿主机和客户机的配置和资源使用状态。
在RHEL 7.3中，libvirtd是作为一个服务（service）配置在系统中的，所以可以通过systemctl命令来对其进行操作（RHEL 6.x等系统中使用service命令）。常用的操作方式有：“systemctl start libvirtd”命令表示启动libvirtd，“systemctl restart libvirtd”表示重启libvirtd，“systemctl reload libvirtd”表示不重启服务但重新加载配置文件（即/etc/libvirt/libvirtd.conf配置文件），“systemctl status libvirtd”表示查询libvirtd服务的运行状态。对libvirtd服务进行操作的命令行演示如下：

[root@kvm-host ~]# systemctl start libvirtd￼ [root@kvm-host ~]#￼ [root@kvm-host ~]# systemctl reload  libvirtd￼ [root@kvm-host ~]#￼ [root@kvm-host ~]# systemctl status libvirtd￼ ● libvirtd.service - Virtualization daemon￼     Loaded: loaded (/usr/lib/systemd/system/libvirtd.service; enabled; vendor preset: enabled)￼     Active: active (running) since Sun 2016-11-06 20:49:45 CST; 16s ago￼       Docs: man:libvirtd(8)￼             http://libvirt.org￼    Process: 7387 ExecReload=/bin/kill -HUP $MAINPID (code=exited, status=0/SUCCESS)￼   Main PID: 7170 (libvirtd)￼     CGroup: /system.slice/libvirtd.service￼             ├─2267 /sbin/dnsmasq --conf-file=/var/lib/libvirt/dnsmasq/default.conf --leasefile-ro --dhcp-script=/usr/...￼             ├─2268 /sbin/dnsmasq --conf-file=/var/lib/libvirt/dnsmasq/default.conf --leasefile-ro --dhcp-script=/usr/...￼             └─7170 /usr/sbin/libvirtd￼ [root@kvm-host ~]#￼ [root@kvm-host ~]# systemctl stop libvirtd￼ [root@kvm-host ~]#￼ [root@kvm-host ~]# systemctl status libvirtd￼ ● libvirtd.service - Virtualization daemon￼    Loaded: loaded (/usr/lib/systemd/system/libvirtd.service; enabled; vendor preset: enabled)￼ ￼ Active: inactive (dead) since Sun 2016-11-06 20:50:08 CST; 5s ago

在默认情况下，libvirtd在监听一个本地的Unix domain socket，而没有监听基于网络的TCP/IP socket，需要使用“-l或--listen”的命令行参数来开启对libvirtd.conf配置文件中TCP/IP socket的配置。另外，libvirtd守护进程的启动或停止，并不会直接影响正在运行中的客户机。libvirtd在启动或重启完成时，只要客户机的XML配置文件是存在的，libvirtd会自动加载这些客户的配置，获取它们的信
