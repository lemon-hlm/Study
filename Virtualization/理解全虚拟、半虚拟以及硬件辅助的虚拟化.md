https://blog.csdn.net/x_i_y_u_e/article/details/50854603

# 1 x86虚拟化概观

“虚拟化”这个术语本身就极大地表明了服务请求和底层物理交付的分离。对于x86虚拟化，在硬件和操作系统之间，添加了一个虚拟化层，如图。

![config](./images/1.png)

这个虚拟化层使得多个操作系统实例可以并行地运行在一台计算机上，并动态地瓜分和共享诸如CPU、存储、内存和I/O设备等物理资源。

对于业界**标准的x86系统**，**虚拟化**采取**hosted**或者**hypervisor架构**。

- **hosted架构**将**虚拟化层**以一个**应用程序的方式**安装运行于**操作系统之上**，支持最为广泛的各种硬件配置。

- **hypervisor(裸金属**)架构将**虚拟化层**直接安装到干净的**x86系统**上，由于它**不需要通过操作系统而直接访问硬件**，hypervisor架构相对于hosted架构**效率更高**，且具有**更好的可扩展性、健壮性和性能**。

VMware Player, ACE, Workstation和Server使用了hosted架构的便捷性，而ESX server针对已认证的硬件采用hypervisor架构以达到数据中心级别的性能。

了解各个组件的大概背景，有助于更好的理解**x86虚拟化技术**。**虚拟化层**是负责**运行和管理所有虚拟机的软件**，运行于**虚拟机监控器(VMM**s)上。如图所示，**虚拟化层！！！**是**直接运行在硬件上的hypervisor！！！**，基于**不同架构**和**实现方法的hypervisor**所具有的**功能有很大不同**。运行于**hypervisor**上的**每个VMM！！！**实现了**虚拟机的硬件抽象！！！**并负责**运行虚拟机系统**，**每个VMM**需要通过分割和共享CPU、内存和I/O设备来完成系统的虚拟化。

![config](./images/2.png)

# 2 CPU虚拟化

## 2.1 x86硬件虚拟化的挑战

**x86操作系统**被设计成**直接运行在硬件**上，自然这些**系统会认为它们拥有硬件的全部控制权(！！！**)。如图所示，**x86架构**为操作系统和应用程序提供了四个不同级别的权限来管理对硬件的访问，分别为ring 0，1，2和3。**用户程序**一般运行在**ring 3**，**操作系统**需要直**接访问内存和硬件！！！**，因此需要在**ring 0**执行它的**特权指令**。

**x86架构**的**虚拟化**需要在**操作系统(运行于最高权限的ring 0)之下**放置一个提供**共享资源的虚拟化层**来创建和管理虚拟机。比较糟的是，**有些敏感指令**在**非ring 0**下执行时具有不同的语义，因此不能很好地将其虚拟化。在**运行时陷入并翻译这些敏感指令和特权指令**是一个艰难的挑战，这使得x86架构的虚拟化起初看起来是不可完成的任务。

![config](./images/3.png)

**VMware**在1998年就攻克了这个挑战，开发了**二进制翻译技术！！！**使得VMM运行在ring 0以达到隔离和性能的要求，而将操作系统转移到比应用程序所在ring 3权限高和比虚拟机监控器所在ring 0权限低的用户级。基于VMware 20000多客户的安装使用情况以及所形成的广大合作伙伴生态系统，**VMware**使用**二进制翻译的全虚拟化方案**已经成为**事实上的标准**，总的来说业界还没有一个开放的标准来定义和管理虚拟化。每个开发虚拟化解决方案的公司可以用不同的方式应对这个技术上的挑战，提供的解决方案良莠不齐。

正如以下阐述的，目前有**三种技术**来实现**x86架构CPU敏感指令**和**特权指令的虚拟化**，分别为：

- 使用**二进制翻译**的**全虚拟化**；

- **操作系统辅助或半虚拟化**；

- **硬件辅助的虚拟化**(第一代)；

### 2.1.1 使用二进制翻译的全虚拟化

使用**二进制翻译**和**直接指令执行相结合**的技术，VMware可以**虚拟化任何基于x86的操作系统**。这种方法如图所示，将**内核代码翻译**，以便使用一系列**作用于虚拟化硬件**可达到所需效果的**新指令序列！！！**替换那些**不可虚拟化的指令**。同时，**用户级的代码直接运行在物理处理器！！！**上保证虚拟化的高性能。**虚拟机监控器(！！！VMM！！！**)为**每个虚拟机(！！！虚拟机和VMM一一对应！！！**)提供类似于**真实物理系统所具有的服务**，如**一个虚拟的BIOS**，**虚拟化设备**和**虚拟化的内存管理**。


