
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [0 ftrace简介](#0-ftrace简介)
  - [0.1 内核编译选项](#01-内核编译选项)

<!-- /code_chunk_output -->

# 0 ftrace简介

ftrace最早出现在**Linux 2.6.27**版本中，其设计目标简单，基于**静态代码插装技术**， **不需要**用户通过**额外的编程**来定义trace行为。

**静态代码插装技术**比较可靠，不会因为**用户的不当使用**而导致**内核崩溃**。

ftrace的名字由**function trace**而来，利用**gcc编译器**的**profile特性**在**所有函数入口处！！！** 添加了一段**插桩(stub) 代码**，**ftrace重载这段代码**来实现**trace功能**。**gcc编译器**的“\-**pg**”选项会在**每个函数入口处**加入**mcount的调用代码**，原本mcount有**libc实现**，因为内核不会链接libc库，因此ftrace编写了自己的**mcountstub** 函数。

## 0.1 内核编译选项

在使用ftrace之前，需要确保内核配置编译了其配置选项。

```
CONFIG_FTRACE=y
CONFIG_HAVE_FUNCTION_TRACER=y
CONFIG_HAVE_FUNCTION_GRAPH_TRACER=y
CONFIG_HAVE_DYNAMIC_FTRACE=y
CONFIG_FUNCTION_TRACER=y
CONFIG_IRQSOFF_TRACER=y

```