
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [0 ftrace简介](#0-ftrace简介)
  - [0.1 内核编译选项](#01-内核编译选项)
  - [0.2 配置选项](#02-配置选项)

<!-- /code_chunk_output -->

# 0 ftrace简介

ftrace最早出现在**Linux 2.6.27**版本中，其设计目标简单，基于**静态代码插装技术**， **不需要**用户通过**额外的编程**来定义trace行为。

**静态代码插装技术**比较可靠，不会因为**用户的不当使用**而导致**内核崩溃**。

ftrace的名字由**function trace**而来，利用**gcc编译器**的**profile特性**在**所有函数入口处！！！** 添加了一段**插桩(stub) 代码**，**ftrace重载这段代码**来实现**trace功能**。**gcc编译器**的“\-**pg**”选项会在**每个函数入口处**加入**mcount的调用代码**，原本mcount有**libc实现**，因为内核不会链接libc库，因此ftrace编写了自己的**mcountstub** 函数。

## 0.1 内核编译选项

在使用ftrace之前，需要确保内核配置编译了其配置选项。

```
CONFIG_FTRACE=y
CONFIG_HAVE_FUNCTION_TRACER=y
CONFIG_HAVE_FUNCTION_GRAPH_TRACER=y
CONFIG_HAVE_DYNAMIC_FTRACE=y
CONFIG_FUNCTION_TRACER=y
CONFIG_IRQSOFF_TRACER=y
CONFIG_SCHED_TRACER=y
CONFIG_ENABLE_DEFAULT_TRACERS=y
CONFIG_FTRACE_SYSCALLS=y
CONFIG_PREEMPT_TRACER=y
```

## 0.2 配置选项

ftrace相关配置选项比较多，针对**不同的跟踪器**有各自**对应的配置选项**。

ftrace通过 **debugfs文件系统**向**用户空间**提供**访问接口**，因此需要在**系统启动时挂载debugfs**, 可以修改系统的/**etc/fstab文件**或**手工挂载**.

```
# mount -t debugfs debugfs /sys/kernel/debug
# mount | grep debugfs
debugfs on /sys/kernel/debug type debugfs (rw,relatime)
```

在/**sys/kernel/debug/trace**目录下提供了各种**跟踪器(tracer**) 和 **event事件**，一些常用的选项如下。

- available_tracers: 列出当前系统支持的跟踪器。
□ available_events: 列出当前系统支持的event事件。
□ cmrentjracer:设置和显示当前正在使用的跟踪器。使用echo命令可以把跟踪
器的名字写入该文件，即可以切换不同的跟踪器。默认为nop, 即不做任何跟踪
操作。
- trace: 读取跟踪信息。通过cat命令查看ftrace记录下来的跟踪信息。
- tracing_on: 用于开始或暂停跟踪。
- trace_options:设置ftrace的一些相关选项。