[TOC]

# 1 什么是bridge？

总结: 虚拟网络设备和虚拟交换机

首先，**bridge**是一个**虚拟网络设备！！！**，所以具有**网络设备的特征**，可以**配置IP**、**MAC地址(！！！**)等；其次，bridge是一个**虚拟交换机！！！**，和物理交换机有类似的功能。

对于**普通的网络设备！！！**来说，只有**两端！！！**，从一端进来的数据会从另一端出去，如**物理网卡**从**外面网络**中收到的**数据**会转发给**内核协议栈！！！**，而从**协议栈**过来的**数据**会转发到外面的**物理网络！！！**中。

而bridge不同，**bridge有多个端口！！！**，数据可以从**任何端口**进来，进来之后从哪个口出去和物理交换机的原理差不多，要**看mac地址**。

# 2 创建bridge

先用iproute2创建一个bridge:

```
dev@debian:~$ sudo ip link add name br0 type bridge
dev@debian:~$ sudo ip link set br0 up
```

创建一个bridge后, 它是一个独立的网络设备, 只有一个端口连着协议栈, 其它的端口什么都没连, 这时候bridge没任何功能. 如图: 

```
+----------------------------------------------------------------+
|                                                                |
|       +------------------------------------------------+       |
|       |             Newwork Protocol Stack             |       |
|       +------------------------------------------------+       |
|              ↑                                ↑                |
|..............|................................|................|
|              ↓                                ↓                |
|        +----------+                     +------------+         |
|        |   eth0   |                     |     br0    |         |
|        +----------+                     +------------+         |
| 192.168.3.21 ↑                                                 |
|              |                                                 |
|              |                                                 |
+--------------|-------------------------------------------------+
               ↓
         Physical Network
```

>这里假设eth0是我们的物理网卡，IP地址是192.168.3.21，网关是192.168.3.1

# 3 将bridge和veth设备相连

创建一对veth设备，并配置上IP

```
dev@debian:~$ sudo ip link add veth0 type veth peer name veth1
dev@debian:~$ sudo ip addr add 192.168.3.101/24 dev veth0
dev@debian:~$ sudo ip addr add 192.168.3.102/24 dev veth1
dev@debian:~$ sudo ip link set veth0 up
dev@debian:~$ sudo ip link set veth1 up
```

将veth0连上br0

```
dev@debian:~$ sudo ip link set dev veth0 master br0
#通过bridge link命令可以看到br0上连接了哪些设备
dev@debian:~$ sudo bridge link
6: veth0 state UP : <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 master br0 state forwarding priority 32 cost 2
```

这时候, 网络变成这样子

```
+----------------------------------------------------------------+
|                                                                |
|       +------------------------------------------------+       |
|       |             Newwork Protocol Stack             |       |
|       +------------------------------------------------+       |
|            ↑            ↑              |            ↑          |
|............|............|..............|............|..........|
|            ↓            ↓              ↓            ↓          |
|        +------+     +--------+     +-------+    +-------+      |
|        | .3.21|     |        |     | .3.101|    | .3.102|      |
|        +------+     +--------+     +-------+    +-------+      |
|        | eth0 |     |   br0  |<--->| veth0 |    | veth1 |      |
|        +------+     +--------+     +-------+    +-------+      |
|            ↑                           ↑            ↑          |
|            |                           |            |          |
|            |                           +------------+          |
|            |                                                   |
+------------|---------------------------------------------------+
             ↓
     Physical Network
```

>这里为图方便, 省略了IP地址前面的192.168, 比如3.21就表示192.168.3.21

br0和veth0相连后, 发生如下变化

- br0和veth0之间连接起来了，并且是双向的通道

- 协议栈和veth0之间变成了单通道，协议栈能发数据给veth0，但veth0从外面收到的数据不会转发给协议栈

- br0的mac地址变成了veth0的mac地址

相当于bridge在veth0和协议栈之间插了一脚，在veth0上面做了点小动作，将veth0本来要转发给协议栈的数据给拦截了，全部转发给bridge了，同时bridge也可以向veth0发数据。

下面来检验一下是不是这样的：

通过veth0 ping veth1失败：

```